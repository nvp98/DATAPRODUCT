@using Data_Product.Models
@using System.Security.Claims;
@using Data_Product.Repositorys;
@using Microsoft.EntityFrameworkCore;
@inject Data_Product.Repositorys.DataContext _context
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="~/Content/assets/Chonse/chosen.jquery.js"></script>
<link href="~/Content/assets/Chonse/chosen.css" rel="stylesheet" />

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

@model IEnumerable<Data_Product.Models.Tbl_BM_16_GangLong>

@{
    var TenTaiKhoan = User.FindFirstValue(ClaimTypes.Name);
    var TaiKhoan = _context.Tbl_TaiKhoan.Where(x => x.TenTaiKhoan == TenTaiKhoan).FirstOrDefault();

}

@if (TempData["msgSuccess"] != null)
{
    @Html.Raw(TempData["msgSuccess"])
}
@if (TempData["msgError"] != null)
{
    @Html.Raw(TempData["msgError"])
}
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";

    Pager pager = new Pager();
    int pageNo = 0;
    if (ViewBag.Pager != null)
    {
        pager = ViewBag.Pager;
        pageNo = pager.CurrentPage;
    }
}
<style>
    body {
        overflow: hidden; /* Ngăn cuộn toàn bộ trang */
    }

    .isolated-layout {
        all: initial;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh; /* Chiếm toàn bộ chiều cao viewport */
        background-color: #ffffff;
        border: 1px solid #dee2e6;
        overflow: hidden; /* Ngăn cuộn container chính */
        font-size: 11px;
    }

    .isolated-layout .header-fixed {
        position: sticky;
        top: 0;
        z-index: 1000;
        background-color: #f8f9fa;
        padding: 10px 0;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .isolated-layout .content {
        flex-grow: 1; 
        display: flex;
        flex-direction: column;
    }

    .isolated-layout .table-container {
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        margin-top: 20px;
        border: 1px solid #dee2e6;
        padding-bottom: 200px; 
    }

    /* Tùy chỉnh thanh cuộn cho WebKit (Chrome, Safari) */
    .isolated-layout .table-container::-webkit-scrollbar {
        width: 2px; /* Chiều rộng thanh cuộn mỏng hơn */
    }

    .isolated-layout .table-container::-webkit-scrollbar-thumb {
        background-color: #888; /* Màu thanh kéo */
        border-radius: 1px; /* Bo góc thanh kéo */
    }

    .isolated-layout .table-container::-webkit-scrollbar-thumb:hover {
        background-color: #555; /* Màu khi hover */
    }

    .isolated-layout .table-container::-webkit-scrollbar-track {
        background-color: #f1f1f1; /* Màu nền thanh cuộn */
    }

    /* Tùy chỉnh thanh cuộn cho Firefox */
    .isolated-layout .table-container {
        scrollbar-width: thin; /* Thanh cuộn mỏng */
        scrollbar-color: #888 #f1f1f1; /* Màu thanh kéo và nền */
    }

    .isolated-layout .table-container table {
        width: 100%;
        margin: 0;
    }

    .isolated-layout .table-container thead th {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }

    .isolated-layout .table-container tbody tr:hover {
        background-color: #f1f3f5;
    }

    .col-5{
        border-right: solid black 1px;
    }

    .filter-item {
        margin-top: 5px;
        height: 40px;
    }

    .table-container {
        width: 100%;
        height: 100%;
    }

    .btn {
        height: 35px;
        margin-left: 20px;
        font-size: 12px;
    }


    .table_tbx {
        border: solid grey 1px;
        max-width: 60px;
        border-radius: 5px;
        padding: 5px 5px;
    }

    .status-card {
        height: 35px;
        width: 80px;
        border-radius: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: 400;
    }
    .status-text{
        padding: 0 !important;
        font-size: 12px;
    }

    .hide-col {
        display: none;
    }

    .chosen-container-single .chosen-single {
        height: 30px; 
        line-height: 30px; 
        font-size: 12px; 
        padding: 0 8px;
    }

    .chosen-container .chosen-drop {
        font-size: 12px;
    }

    .chosen-container {
        font-size: 12px;
    }

    .chosen-container-single .chosen-single span {
        margin-right: 20px;
    }
</style>
<div class="isolated-layout">
    <div class="header-fixed">
        <div class="container-fluid">
            <input type="text" style="display: none" id="ID_currentUser" value="@TaiKhoan.ID_TaiKhoan" />
            <div class="row">
                <div class="col-5">
                    <h5><strong>KHU VỰC NHẬN THÙNG</strong></h5>
                    <hr />
                    <div class="row g-3">
                        <!-- Cột chứa các input/dropdown -->
                        <div class="col-12">
                            <div class="row g-3">
                                <!-- Ngày làm việc -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="NgayLamViec" class="col-sm-5 col-form-label">Ngày làm việc: </label>
                                        <div class="col-sm-7">
                                            <input type="date" class="form-control form-control-sm" id="ID_NgayLamViec" name="NgayLamViec"
                                                   min="@ViewBag.MinDate"
                                                   max="@ViewBag.MaxDate"
                                                   value="@ViewBag.DefaultDate"
                                                   onkeydown="return false;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Ca làm việc -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="CaLamViec" class="col-sm-5 col-form-label">Ca làm việc: </label>
                                        <div class="col-sm-7">
                                            <select class="form-select form-select-sm" id="IDCaLamViec" name="CaLamViec">
                                                <option value="">-- Ca làm việc --</option>
                                                <option value="1">Ca 1</option>
                                                <option value="2">Ca 2</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Lò cao -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="LoCao" class="col-sm-5 col-form-label">Lò cao:</label>
                                        <div class="col-sm-7">
                                            <select class="form-select form-select-sm" id="IDLoCao" name="LoCao">
                                                <option value="">-- Lò cao --</option>
                                                @foreach (var locao in ViewBag.LoCaoList)
                                                {
                                                    <option value="@locao.ID">@locao.TenLoCao</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chuyển đến -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="ChuyenDen" class="col-sm-5 col-form-label">Chuyển đến:</label>
                                        <div class="col-sm-7">
                                            <select class="form-select form-select-sm" id="IDChuyenDen" name="ChuyenDen">
                                                <option value="">-- Chuyển đến --</option>
                                                <option value="HRC1">HRC 1</option>
                                                <option value="DUC1">Đúc 1</option>
                                                <option value="HRC2">HRC 2</option>
                                                <option value="DUC2">Đúc 2</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tình trạng -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="ChuyenDen" class="col-sm-5 col-form-label">Tình trạng:</label>
                                        <div class="col-sm-7">
                                            <select class="form-select form-select-sm" id="IDTinhTrang" name="TinhTrang">
                                                <option value="">-- Tình trạng --</option>
                                                <option value="4">Đã nhận</option>
                                                <option value="2">Chờ xử lý</option>
                                                @* @foreach (var trangthai in ViewBag.TinhTrangList)
                                                {
                                                    <option value="@trangthai.Value">@trangthai.Text</option>
                                                } *@
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- Timf kieem -->
                                <div class="col-lg-6 col-12 d-flex  justify-content-end filter-item">
                                    <button class="btn btn-primary btn-sm px-4" id="btnSeachLG">Tìm kiếm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3 d-flex align-items-end">
                        <div class="col-12 d-flex justify-content-end">
                            <button class="btn btn-warning btn-sm px-4" id="btnLuuKR">Lưu KR</button>
                            <button class="btn btn-success btn-sm px-4" id="IDbtnNhanThung">Nhận</button>
                            <button class="btn btn-danger btn-sm px-4" id="IDbtnHuyNhanThung" style="display:none">Hủy nhận</button>

                        </div>
                    </div>
                </div>
                <div class="col-7">
                    <h5><strong>KHU VỰC XỬ LÝ SỐ LIỆU</strong></h5>
                    <hr />
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="row g-3">
                                <!-- Ngày làm việc -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="ngayLamViec" class="col-sm-4 col-form-label">Ngày làm việc: </label>
                                        <div class="col-sm-8">
                                            <input type="date" class="form-control form-control-sm" id="IDNgayNhan" name="ngayLamViec" min="@ViewBag.MinDate"
                                                   max="@ViewBag.MaxDate"
                                                   value="@ViewBag.DefaultDate"
                                                   onkeydown="return false;">
                                        </div>
                                    </div>
                                </div>

                                <!-- Ca làm việc -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="caLamViec" class="col-sm-3 col-form-label">Ca làm việc: </label>
                                        <div class="col-sm-9">
                                            <select class="form-select form-select-sm" id="IDCaNhan" name="CaNhan">
                                                <option value="">-- Ca làm việc --</option>
                                                <option value="1">Ca 1</option>
                                                <option value="2">Ca 2</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Lò thổi -->
                                <div class="col-lg-6 col-12 filter-item">
                                    <div class="row mb-3">
                                        <label for="caLamViec" class="col-sm-4 col-form-label">Lò thổi: </label>
                                        <div class="col-sm-8">
                                            <select class="form-select form-select-sm" id="IDLoThoi" name="LoThoi">
                                                <option value="">-- Lò thổi --</option>
                                                @foreach (var lothoi in ViewBag.LoThoiList)
                                                {
                                                    <option value="@lothoi.ID">@lothoi.TenLoThoi</option>
                                                }
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <!-- Timf kieem -->
                                <div class="col-lg-6 col-12 d-flex justify-content-end filter-item">
                                    <button class="btn btn-primary btn-sm px-4" id="btnSeachThungDaNhan">Tìm kiếm</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-3" style="position: absolute;bottom: 10px;right: 12px;">
                        <div class="col-12 d-flex justify-content-end">
                            <button class="btn btn-warning btn-sm px-4" id="BtnAnHien">Ẩn/Hiện</button>
                            <button class="btn btn-warning btn-sm px-4" id="BtnLuu">Lưu</button>
                            <button class="btn btn-success btn-sm px-4" id="BtnXuatPhieuExcel">Xuất Excel</button>
                            <button class="btn btn-success btn-sm px-4" id="BtnXuatPhieuPDF">Xuất PDF</button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalTaoMeThoi" onclick="loadModalTaoMe()">Tạo Mẻ thổi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="content">
        <div class="container-fluid">
            <div class="row"> 
                <div class="col-5 left-container">
                    <div class="table-container" role="region" aria-label="Scrollable Table 1">
                        <table class="table table-bordered text-center align-middle table-hover" id="IDtbKhuVucNhanThung">
                            <thead>
                                <tr>
                                    <th>Giờ NM</th>
                                    <th>Mã thùng gang</th>
                                    <th>Lò cao</th>
                                    <th>Thùng số</th>
                                    <th>Chuyển đến</th>
                                    <th>KR</th>
                                    <th>Chọn thùng</th>
                                    <th>Tình trạng</th>
                                    <th>Người nhận</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="col-7 right-container">
                    <div class="table-container" role="region" aria-label="Scrollable Table 2">
                        <table class="table table-bordered text-center align-middle table-hover" id="IDtbXuLySoLieu">
                            <thead>
                                <tr>
                                    <th class="hide-col">Mã thùng thép</th>
                                    <th>Lò cao</th>
                                    <th>Thùng số</th>
                                    <th>Khối lượng thùng & gang lỏng (T)</th>
                                    <th>Khối lượng thùng (T)</th>
                                    <th>Khối lượng gang lỏng (T)</th>
                                    <th>Thùng trung gian</th>
                                    <th>KL thùng & gang lỏng (T) </th>
                                    <th>KL thùng (T)</th>
                                    <th>KL vào lò thổi </th>
                                    <th>Mẻ thổi</th>
                                    <th>Ghi chú</th>
                                    <th>Trạng thái</th>
                                </tr>
                            </thead>
                            <tbody>
                            </tbody>
                            @* hàng cuối để chốt tổng khối lượng thùng *@ 
                             <tfoot>
                                <tr style="height: 50px;">
                                    <td class="total-space" colspan="8" style="font-weight: 600; text-align: start">Tổng</td>
                                    <td id="IDTongKLVaoLoThoi" style="font-weight: 600">
                                        0.00
                                    </td>
                                    <td colspan="3"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
  


    

    <!-- Modal form tạo mẻ thổi -->
    <div class="modal fade" id="modalTaoMeThoi" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tạo Mẻ thổi</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
          </div>
            <div class="modal-body" id="modalTaoMe">
          </div>
        </div>
      </div>
    </div>


<script>
    window.meThoiList = @Html.Raw(Json.Serialize(ViewBag.MeThoiList));
</script>


    @* logic auto tinhs toan so lieu*@
    <script type="text/javascript">
        // render card trạng thái
        function renderStatusCard(tinhTrang) {
            const statusMap = {
                1: { label: "Chưa chuyển", bgClass: "bg-secondary", textColor: "white" },
                2: { label: "Chờ xử lý", bgClass: "bg-warning", textColor: "black" },
                3: { label: "Đã chuyển", bgClass: "bg-success", textColor: "white" },
                4: { label: "Đã nhận", bgClass: "bg-success", textColor: "white" },
                5: { label: "Đã chốt", bgClass: "bg-success", textColor: "white" },
            };

            const { label, bgClass, textColor } = statusMap[tinhTrang] || {
                label: "Không rõ", bgClass: "bg-light", textColor: "black"
            };

            return `
                <div class="status-card ${bgClass}">
                <span class="status-text small pt-2 ps-1" style="color: ${textColor};">
                        ${label}
                    </span>
                </div>
            `;
        }

        // render khu vực xử lý số liệu
        function renderTableXuLySoLieu(data) {
            const tbody = $('#IDtbXuLySoLieu tbody');
            tbody.empty();
            if(data.length){
                data.forEach(item => {
                    const tinhTrangHTML = renderStatusCard(item.iD_TrangThai);
                    const html = `
                            <tr data-id="${item.id}">
                                <td class="hide-col">${item.maThungThep}</td>
                                <td>${item.iD_Locao}</td>
                                <td>${item.bkmiS_ThungSo}</td>
                                <td>
                                    <input class="table_tbx KhoiLuongThungVaGangLong" type="number" name="KhoiLuongThungVaGangLong" value="${item.t_KLThungVaGang ?? ''}" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                <td class="KLThung">
                                    <input class="table_tbx KhoiLuongThung" type="number" name="KhoiLuongThung" value="${item.t_KLThungChua ?? ''}" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                    <td class="KLGangLong">${item.t_KLGangLong ?? '00.0'}</td>
                                <td>
                                    <input class="table_tbx" type="number" name="ThungTrungGian" id="IDThungTrungGian" value="${item.thungTrungGian ?? ''}" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                <td>
                                    <input class="table_tbx KLThungVaGangLongVaoLoThoi" type="number" name="KLThungVaGangLongVaoLoThoi" value="${item.t_KLThungVaGang_Thoi ?? ''}" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                <td>
                                    <input class="table_tbx KLThungVaoLoThoi" type="number" name="KLThungVaoLoThoi"  value="${item.t_KLThungChua_Thoi ?? ''}" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                <td id="IDKLVaoLoThoi" class="KLVaoLoThoi">${item.t_KLGangLongThoi ?? '00.0'}</td>
                                <td class="meThoi">
                                <select class="form-control selectMeThoi" style="width:100%;" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}>
                                        <option value="">-- Mẻ thổi --</option>
                                        ${item.iD_MeThoi && !window.meThoiList.some(m => m.id === item.iD_MeThoi)
                                            ? `<option value="${item.iD_MeThoi}" selected>${item.maMeThoi}</option>`
                                            : ''
                                        }
                                        ${window.meThoiList.map(m =>
                                            `<option value="${m.id}" ${m.id === item.iD_MeThoi ? 'selected' : ''}>${m.maMeThoi}</option>`
                                        ).join('')}
                                    </select>
                                </select>
                                </td>
                                <td>
                                <input class="table_tbx" type="text" name="GhiChu" id="IDGhiChu" value="${item.t_GhiChu ?? '' }" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                                </td>
                                <td>
                                    ${tinhTrangHTML}
                                </td>
                            </tr>
                      `;
                    tbody.append(html);
                    tbody.find(".selectMeThoi").chosen({ width: "100%" });
                    sumPhieu();
              });
          } else {
              const html = `
                    <tr>
                        <td colspan="14" class="text-center text-muted" style="padding: 20px; font-size: 20px; font-weight: 600;">
                            Không tìm thấy dữ liệu
                        </td>
                    </tr>
                `;
               tbody.append(html);
          }
        }
        

        //render table Khu Vuc Nhan Thung
        function renderTableNhanThung(data) {
            const tbody = $('#IDtbKhuVucNhanThung tbody');
            tbody.empty();
            if(data.length){
                data.forEach(item => {
                const tinhTrangHTML = renderStatusCard(item.iD_TrangThai == 5 ? item.iD_TrangThai : item.t_ID_TrangThai);

                const nguoiNhanHtml = item.nguoiNhanList.length > 0
                    ? item.nguoiNhanList.join('<br>')
                    : '';

                const html = `
                <tr data-id="${item.id}" data-mathung="${item.maThungGang}">
                    <td>${item.gio_NM}</td>
                    <td>${item.maThungGang}</td>
                    <td>${item.iD_Locao}</td>
                    <td>${item.bkmiS_ThungSo}</td>
                    <td>${item.chuyenDen}</td>
                        <td>
                            <input type="checkbox" class="cbx-luuKR" name="KR" value="${item.kr}"  ${item.kr ? "checked" : ""} ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                        </td>
                        <td>
                            <input type="checkbox" class="cbx-nhanThung" name="ChonThung" value="" ${item.iD_TrangThai == 5 ? "disabled readonly" : ""}/>
                        </td>
                        <td class="status-cell" data-status="${item.iD_TrangThai == 5 ? item.iD_TrangThai : item.t_ID_TrangThai}">
                            ${tinhTrangHTML}
                        </td>
                        <td class="nguoi-nhan">
                            ${nguoiNhanHtml}
                        </td>
                    </tr>
                    `;
                tbody.append(html);
                });
            } else {
               const html = `
                    <tr>
                        <td colspan="14" class="text-center text-muted" style="padding: 20px; font-size: 20px; font-weight: 600;">
                            Không tìm thấy dữ liệu
                        </td>
                    </tr>
                `;
                tbody.append(html);
            }
        }


        // Search Luyen Gang de nhan thung
        function SearchLT() {
            // value cac field
            const NgayLamViec = $('#ID_NgayLamViec').val() || null;
            const IDCaLamViec = $('#IDCaLamViec').val() || null;
            const IDLoCao = $('#IDLoCao').val() || null;
            const IDChuyenDen = $('#IDChuyenDen').val() || null;
            const IDTinhTrang = $('#IDTinhTrang').val() || null;

            const payload = {
                NgayLuyenGang: NgayLamViec,
                ID_TrangThai: IDTinhTrang,
                ID_Locao: IDLoCao,
                ChuyenDen: IDChuyenDen,
                G_Ca: IDCaLamViec
            };

            $.ajax({
                url: '/BM_GangThoi_Thep/SearchLT',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    renderTableNhanThung(data);
                },
                error: function (err) {
                    alert("Lỗi khi tìm kiếm dữ liệu");
                }
            });
        }

        function SearchThungDaNhanTheoUser(){
            // value cac field
            const NgayNhan = $('#IDNgayNhan').val() || null;
            const IDCaNhan = $('#IDCaNhan').val() || null;
            const IDLoThoi = $('#IDLoThoi').val() || null;

            const payload = {
                NgayLamViec: NgayNhan,
                ID_LoThoi: IDLoThoi,
                T_Ca: IDCaNhan
            };
            $.ajax({
                url: '/BM_GangThoi_Thep/TimKiemThungDaNhan',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function (data) {
                    renderTableXuLySoLieu(data);

                },
                error: function (err) {
                    alert("Lỗi khi tìm kiếm dữ liệu");
                }
            });
        }

         // tinh sum
        function sumPhieu(){
            let total = 0;
            $("#IDtbXuLySoLieu .KLVaoLoThoi").each(function () {
                const value = parseFloat($(this).text());
                if (!isNaN(value)) {
                    total += value;
                }
            });
            $("#IDTongKLVaoLoThoi").text(total.toFixed(2));
        }
        // Logic Luu
        function getTableData() {
            const data = [];

            $('#IDtbXuLySoLieu tbody tr').each(function () {
                const row = $(this);
                const rowData = {
                    ID: row.data('id') || null,
                    T_KLThungVaGang: row.find('input[name="KhoiLuongThungVaGangLong"]').val()|| null,
                    T_KLThungChua: row.find('input[name="KhoiLuongThung"]').val()|| null,
                    T_KLGangLong: row.find('.KLGangLong').text().trim()|| null,
                    ThungTrungGian: row.find('input[name="ThungTrungGian"]').val()|| null,
                    T_KLThungVaGang_Thoi: row.find('input[name="KLThungVaGangLongVaoLoThoi"]').val()|| null,
                    T_KLThungChua_Thoi: row.find('input[name="KLThungVaoLoThoi"]').val()|| null,
                    T_KLGangLongThoi: row.find('.KLVaoLoThoi').text().trim()|| null,
                    ID_MeThoi:  parseInt(row.find('.selectMeThoi').val())|| null,
                    GhiChu: row.find('input[name="GhiChu"]').val()|| null
                };
                data.push(rowData);
            });

            return data;
        }

        // xu ly khi load
        $(document).ready(function () {

            // render tim kiem ban dau
             const today = new Date().toISOString().split("T")[0];
            $('#ID_NgayLamViec').val(today);

            SearchLT(); // call hàm search
            SearchThungDaNhanTheoUser()// call hàm search
            
            

            // Tính khối lượng gang lỏng khi nhập vào KL Thùng & gang lỏng
            $('#IDtbXuLySoLieu').on('input', '.KhoiLuongThungVaGangLong, .KhoiLuongThung', function () {
                const $row = $(this).closest('tr');
                const KLThungVaGangLongVaoLoThoi = parseFloat($row.find('.KhoiLuongThungVaGangLong').val());
                const KLThungVaoLoThoi = parseFloat($row.find('.KhoiLuongThung').val());

                    if (!isNaN(KLThungVaGangLongVaoLoThoi) && !isNaN(KLThungVaoLoThoi) && KLThungVaGangLongVaoLoThoi >= KLThungVaoLoThoi) {
                        const result = KLThungVaGangLongVaoLoThoi - KLThungVaoLoThoi;
                    $row.find('.KLGangLong').text(result.toFixed(2));
                       
                    } else {
                        $row.find('.KLGangLong').text("0.00");
                    }
            });

           

            // Tính khối lượng vào lò thổi khi nhập vào KL Thùng & gang lỏng vào lò thổi
            $('#IDtbXuLySoLieu').on('input', '.KLThungVaGangLongVaoLoThoi, .KLThungVaoLoThoi', function () {
                const $row = $(this).closest('tr'); 
                const KLThungVaGangLongVaoLoThoi = parseFloat($row.find('.KLThungVaGangLongVaoLoThoi').val());
                const KLThungVaoLoThoi = parseFloat($row.find('.KLThungVaoLoThoi').val());

                if (!isNaN(KLThungVaGangLongVaoLoThoi) && !isNaN(KLThungVaoLoThoi) && KLThungVaGangLongVaoLoThoi >= KLThungVaoLoThoi) {
                    const result = KLThungVaGangLongVaoLoThoi - KLThungVaoLoThoi; 
                    $row.find('.KLVaoLoThoi').text(result.toFixed(2));
                    
                    sumPhieu();
                    
                } else {
                    $row.find('#IDKLVaoLoThoi').text("0.00");
                }
            });
        
            // event An/Hien ma Thùng Thép
            $('#BtnAnHien').click(function() {
                $('.hide-col').toggle();
                if ($('.hide-col:first').is(':visible')) {
                  $('.total-space').attr("colspan", 9)
                } else {
                  $('.total-space').attr("colspan", 8)
                }
                
            });

            
            // Btn search LT
            $('#btnSeachLG').click(function () {
                SearchLT();
            });

            // Btn search Thung Da Nhan
            $('#btnSeachThungDaNhan').click(function () {
                SearchThungDaNhanTheoUser();
            });

             // Luu KR
            $('#btnLuuKR').click(function () {
                let selectedList = [];
                $('#IDtbKhuVucNhanThung tbody tr').each(function () {
                    const id = $(this).data('id');
                    const checkbox = $(this).find('.cbx-luuKR');
                    let isChecked = false;
                    if (checkbox.is(':checked')) {
                        isChecked = true;
                    }
                    selectedList.push({id: id, isChecked: isChecked});
                });

                if (selectedList.length === 0) {
                    alert("Vui lòng chọn ít nhất 1 dòng.");
                    return;
                }
                $.ajax({
                    url: "/BM_GangThoi_Thep/LuuKR",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(selectedList),
                    processData: false,
                    success: function (res) {
                        alert("Lưu KR thành công!")
                    }
                })
            });

            // logic huy nhan thung
            // Khi checkbox thay đổi
            $(document).on('change', '.cbx-nhanThung', function () {
                let showButton = false;
                $('.cbx-nhanThung:checked').each(function () {
                    const row = $(this).closest('tr');
                    const status = parseInt(row.find('.status-cell').data('status'));
                    if (status === 4) { // 4 = Đã nhận
                        showButton = true;
                        return false;
                    }
                });
                if (showButton) {
                    $('#IDbtnHuyNhanThung').show();
                } else {
                    $('#IDbtnHuyNhanThung').hide();
                }
            });

            $('#IDbtnHuyNhanThung').click(function () {

                const selectedRows = $('.cbx-nhanThung:checked');
                if (selectedRows.length === 0) {
                    alert("Vui lòng chọn ít nhất 1 dòng.");
                    return;
                }

                let isValid = true;
                const invalidMaThungs = [];
                const selectedMaThungs = [];

                selectedRows.each(function () {
                    const row = $(this).closest('tr');
                    const status = parseInt(row.find('.status-cell').data('status'));
                    const maThung = row.data('mathung');

                    if (status !== 4) { // 4 = Đã nhận
                        isValid = false;
                        invalidMaThungs.push(maThung);
                    }

                    selectedMaThungs.push(maThung);
                });

                if (!isValid) {
                    alert('Chỉ được hủy những thùng đã nhận.\nCác thùng không hợp lệ: ' + invalidMaThungs.join(', '));
                    return;
                }

                const payload = {
                    selectedMaThungs,
                    idNguoiHuyNhan: $('#ID_currentUser').val()
                };

                $.ajax({
                    url: "/BM_GangThoi_Thep/HuyNhan",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    success: function (res) {
                        if(res.success){
                            // render lai
                            SearchLT();
                            SearchThungDaNhanTheoUser();
                        }
                    }
                });
            });

             // logic nhan thung 
            $('#IDbtnNhanThung').click(function () {
                let selectedIds = [];
                $('#IDtbKhuVucNhanThung tbody tr').each(function () {
                    const checkbox = $(this).find('.cbx-nhanThung');
                    if (checkbox.is(':checked')) {
                        const id = $(this).data('id');
                        selectedIds.push(id);
                    }
                });

                if (selectedIds.length === 0) {
                    alert("Vui lòng chọn ít nhất 1 dòng.");
                    return;
                }

                // ID current user
                const ID_currentUser = $('#ID_currentUser').val();

                const NgayNhan = $('#IDNgayNhan').val();
                const IDCaNhan = $('#IDCaNhan').val();
                const IDLoThoi = $('#IDLoThoi').val();

                if(!NgayNhan){
                    alert("Vui lòng chọn Ngày Nhận"); return;
                }
                if(!IDCaNhan ){
                    alert("Vui lòng chọn Ca"); return;
                }
                if(!IDLoThoi){
                    alert("Vui lòng chọn Lò thổi"); return;
                }

                const payload = {
                    selectedIds,
                    ngayNhan: NgayNhan,
                    idCa: IDCaNhan,
                    idLoThoi: IDLoThoi,
                    idNguoiNhan: ID_currentUser
                }

                $.ajax({
                    url: "/BM_GangThoi_Thep/Nhan",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(payload),
                    processData: false,
                    success: function (res) {
                        // render lai 
                        SearchLT();

                        // render cac thung da nhan
                        SearchThungDaNhanTheoUser();
                    },
                    error: function () {
                        alert("Lỗi khi nhận dữ liệu!");
                    }
                });
            });
        });
         
        // logic luu
        $('#BtnLuu').click(function () {
            const payload = getTableData();
            $.ajax({
                url: "/BM_GangThoi_Thep/Luu",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(payload),
                processData: false,
                success: function (res) {
                    alert("Lưu thành công!");
                    // SearchThungDaNhanTheoUser();
                },
                error: function () {
                    alert("Lỗi khi nhận dữ liệu!");
                }
            })
        })
</script>
@* Logic me thoi *@
<script>
    // open modal tao me
    function loadModalTaoMe() {
        $.ajax({
            url: '/MeThoi/TaoMeThoi', 
            type: 'GET',
            success: function (html) {
                $('#modalTaoMe').html(html);
            },
            error: function () {
                $('#modalTaoMe').html('<div class="text-danger">Không thể tải nội dung.</div>');
            }
        });
    }

    // tao me
    function submitTaoMe() {
        const maLoThoi = $('#formLoThoi').val();
        const soLuong = $('#formSoLuong').val();

        const selectedOption = $('#formLoThoi option:selected');
        const idLoThoi = selectedOption.data('id');

        if(!soLuong){
            alert("Vui lòng nhập số lượng mẻ thổi muốn tạo"); return;
        }
        if(!maLoThoi){
            alert("Vui lòng chọn Lò thổi"); return;
        }

        $.ajax({
            url: '/MeThoi/TaoMeThoi',
            method: 'POST',
            contentType: 'application/json',
            processData: false,
            data: JSON.stringify({
                maLoThoi: maLoThoi,
                soLuong: parseInt(soLuong),
                id_LoThoi: idLoThoi
            }),
            success: function (res) {
                $('#btnDongModalTaoMeThoi').click();
                    alert("Tạo mẻ thổi thành công!");
                window.location.reload();
            },
            error: function (err) {
                alert("Tạo mẻ thổi thất bại")
            }
        });
    }
</script>
