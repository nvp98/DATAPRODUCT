@{
    ViewData["Title"] = "Home Page";
}
@using System.Security.Claims;
@*<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">*@
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .color_def{
        color: #06428b
    }
    .bg_def{
        background-color: #06428b;
    }
</style>
@{
    var phieu = ViewBag.TongPhieuNhatKy as Dictionary<string, int>;
    int tongNK = phieu != null && phieu.ContainsKey("Tong_NK") ? phieu["Tong_NK"] : 0;
    int daXuLyNK = phieu != null && phieu.ContainsKey("DaXuLy_NK") ? phieu["DaXuLy_NK"] : 0;
    int chuaXuLyNK = phieu != null && phieu.ContainsKey("ChuaXuLy_NK") ? phieu["ChuaXuLy_NK"] : 0;
    // Tính toán tỷ lệ, tránh chia 0
    double tileDaXuLyNK = tongNK > 0 ? (double)daXuLyNK / tongNK * 100 : 0;
    double tileChuaXuLyNK = 100 - tileDaXuLyNK;
    //BBGN
    int tongBBGN = phieu != null && phieu.ContainsKey("Tong_BBGN") ? phieu["Tong_BBGN"] : 0;
    int daXuLyBBGN = phieu != null && phieu.ContainsKey("DaXuLy_BBGN") ? phieu["DaXuLy_BBGN"] : 0;
    int chuaXuLyBBGN = phieu != null && phieu.ContainsKey("ChuaXuLy_BBGN") ? phieu["ChuaXuLy_BBGN"] : 0;
    // Tính toán tỷ lệ, tránh chia 0
    double tileDaXuLyBBGN = tongNK > 0 ? (double)daXuLyBBGN / tongBBGN * 100 : 0;
    double tileChuaXuLyBBGN = 100 - tileDaXuLyBBGN;
    string d_none = ViewBag.ID_Quyen > 3 ? "d-none" : "";
}
<div class="text-center">
    <section class="section dashboard">
        <div class="row">

            <!-- Left side columns -->
            <div class="col-lg-12" style="padding-top: 1%;">
                <div class="row">

                    <!-- Sales Card -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card info-card sales-card">
                            <a href="@Url.Action("Index","BM_11")">
                                <div class="card-body" style="padding: 15px;">

                                    <div class="d-flex align-items-center">
                                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="bi bi-send-plus"></i>
                                        </div>
                                        <div class="ps-3">
                                            <h6 style="text-align: left;">@ViewBag.ViecToiBatDau</h6>
                                            <span class="small pt-2 ps-1" style="color:#06428b ">Việc tôi bắt đầu trong ngày</span>

                                        </div>
                                    </div>
                                </div>
                            </a>
                            

                        </div>
                    </div><!-- End Sales Card -->
                    <!-- Revenue Card -->
                    <div class="col-xxl-3 col-md-6">
                        <div class="card info-card revenue-card">
                            <a href="@Url.Action("Index", "XuLyPhieu")">
                                <div class="card-body" style="padding: 15px;">

                                    <div class="d-flex align-items-center">
                                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="bi bi-send-arrow-down"></i>
                                        </div>
                                        <div class="ps-3">
                                            <h6 style="text-align: left;">@ViewBag.ViecDenToi</h6>
                                            <span class="small pt-2 ps-1" style="color:#06428b ">Việc đến tôi trong ngày</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                           

                        </div>
                    </div><!-- End Revenue Card -->
                    <!-- Customers Card -->
                    <div class="col-xxl-3 col-xl-12">

                        <div class="card info-card customers-card">
                            <a href="@Url.Action("Index", "XuLyPhieu")">
                                <div class="card-body" style="padding: 15px;">

                                    <div class="d-flex align-items-center">
                                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="bi bi-send-slash"></i>
                                        </div>
                                        <div class="ps-3">
                                            <h6 style="text-align: left;">@ViewBag.ChuaXuLy</h6>
                                            <span class="small pt-2 ps-1" style="color:#06428b ">Chưa xử lý trong ngày</span>
                                        </div>
                                    </div>

                                </div>
                            </a>
                            
                        </div>

                    </div><!-- End Customers Card -->
                    <div class="col-xxl-3 col-xl-12">

                        <div class="card info-card customers-card">
                            <a href="@Url.Action("Index", "XuLyPhieu")">
                                <div class="card-body" style="padding: 15px;">

                                    <div class="d-flex align-items-center">
                                        <div class="card-icon rounded-circle d-flex align-items-center justify-content-center">
                                            <i class="bi bi-send-check"></i>
                                        </div>
                                        <div class="ps-3">
                                            <h6 style="text-align: left;">@ViewBag.DaXuLy</h6>
                                            <span class="small pt-2 ps-1" style="color:#06428b ">Đã xử lý trong ngày</span>
                                        </div>
                                    </div>

                                </div>
                            </a>
                            
                        </div>

                    </div><!-- End Customers Card -->
                </div>
            </div><!-- End Left side columns -->
            <!-- Right side columns -->
            <div class="col-lg-12 pt-1 @d_none">
               @* <form id="formChonThang" method="get" asp-action="ThongKePhieu" class="mb-3">
                    <label for="thang">Chọn tháng:</label>
                    <input type="month" name="thang" id="thang" class="form-control w-auto d-inline-block"
                           value="@DateTime.Now" />
                    <button type="submit" class="btn btn-primary ms-2">Xem</button>
                </form>*@
                <div class="row">
                    @*BM.11/QT.05 (Biên bản giao nhận nguyên/nhiên/vật tư)*@
                    <div class="col-md-6" >
                        <a href="@Url.Action("Index_All", "BM_11")" class="">
                            <div class="card shadow-sm border-0 mb-3">
                                <div class="card-body p-3">
                                    <!-- Tên biểu mẫu -->
                                    <div class="list-group-item d-flex justify-content-between align-items-center bg-opacity-10 fw-bold text-center" style="color:#06428b ">
                                        BM.11/QT.05 (Biên bản giao nhận nguyên/nhiên/vật tư)
                                    </div>

                                    <!-- Tổng số phiếu -->
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded bg-light border">
                                        <div class=" fw-semibold" style="color:#06428b ">Tổng số phiếu</div>
                                        <div class="fs-4 fw-bold " style="color:#06428b " id="TongBBGN">@tongBBGN</div>
                                    </div>
                                    <!-- Tổng sản lượng -->
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded bg-light border">
                                        <div class=" fw-semibold" style="color:#06428b ">Tổng Sản lượng (Tấn)</div>
                                        <div class="fs-4 fw-bold " style="color:#06428b " id="TongSanLuongBBGN"></div>
                                    </div>

                                    <!-- Đã xử lý -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div class="text-success fw-semibold">Đã xử lý</div>
                                        <div class="text-success fw-bold" id="TiLeDaXuLyBBGN">@daXuLyBBGN (@tileDaXuLyBBGN %)</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" id="TiLeDXLBBGN" role="progressbar" style="width: @tileDaXuLyBBGN%" " ></div>
                                    </div>

                                    <!-- Chưa xử lý -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div class="text-warning fw-semibold">Chưa xử lý</div>
                                        <div class="text-warning fw-bold" id="TiLeChuaXuLyBBGN">@chuaXuLyBBGN (@tileChuaXuLyBBGN %)</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-warning" id="TiLeCXLBBGN" role="progressbar" style="width: @tileChuaXuLyBBGN%"></div>
                                    </div>

                                    <!-- Tỷ lệ hoàn thành -->
                                   @* <div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted">Tỷ lệ hoàn thành</div>
                                        <div class="fw-bold text-primary">85.7%</div>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 85.7%"></div>
                                    </div>*@
                                </div>
                            </div>
                        </a>

                    </div>
                    @*BM.12/QT.05 (Nhật ký dừng sản xuất)*@
                    <div class="col-md-6">
                        <a href="@Url.Action("Index_All", "BM_NhatKy_SanXuat")" class="">
                            <div class="card shadow-sm border-0 mb-3">
                                <div class="card-body p-3">
                                    <!-- Tên biểu mẫu -->
                                    <div class="list-group-item d-flex justify-content-between align-items-center bg-opacity-10 fw-bold text-center" style="color:#06428b ">
                                        BM.12/QT.05 (Nhật ký dừng sản xuất)
                                    </div>

                                    <!-- Tổng số phiếu -->
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded bg-light border">
                                        <div class=" fw-semibold" style="color:#06428b ">Tổng số phiếu</div>
                                        <div class="fs-4 fw-bold " style="color:#06428b " id="TongNK">@tongNK</div>
                                    </div>
                                    <!-- Tổng sản lượng -->
                                    <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded bg-light border">
                                        <div class=" fw-semibold" style="color:#06428b ">Tổng Thời gian dừng (Giờ)</div>
                                        <div class="fs-4 fw-bold " style="color:#06428b " id="TongThoiGianNK"></div>
                                    </div>

                                    <!-- Đã xử lý -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div class="text-success fw-semibold">Đã xử lý</div>
                                        <div class="text-success fw-bold" id="TiLeDaXuLyNK">@daXuLyNK (@tileDaXuLyNK%)</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" id="TiLeDXLNK" role="progressbar" style="width: @tileDaXuLyNK%"></div>
                                    </div>

                                    <!-- Chưa xử lý -->
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <div class="text-warning fw-semibold">Chưa xử lý</div>
                                        <div class="text-warning fw-bold" id="TiLeChuaXuLyNK">@chuaXuLyNK (@tileChuaXuLyNK %)</div>
                                    </div>
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-warning" id="TiLeCXLNK" role="progressbar" style="width: @tileChuaXuLyNK%"></div>
                                    </div>

                                    <!-- Tỷ lệ hoàn thành -->
                                    @*<div class="d-flex justify-content-between align-items-center">
                                        <div class="text-muted">Tỷ lệ hoàn thành</div>
                                        <div class="fw-bold text-primary">85.7%</div>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary" role="progressbar" style="width: 85.7%"></div>
                                    </div>*@
                                </div>
                            </div>
                        </a>
                       
                    </div>
                    @*Gang lỏng - Gang thỏi*@
                   @* <div class="col-md-4">
                        <div class="card shadow-sm border-0 mb-3">
                            <div class="card-body p-3">
                                <!-- Tên biểu mẫu -->
                                <div class="list-group-item d-flex justify-content-between align-items-center bg-opacity-10 fw-bold text-center" style="color:#06428b ">
                                    Gang lỏng - Gang thỏi
                                </div>

                                <!-- Tổng số phiếu -->
                                <div class="d-flex justify-content-between align-items-center mb-3 p-2 rounded bg-light border">
                                    <div class=" fw-semibold" style="color:#06428b ">Tổng số phiếu</div>
                                    <div class="fs-4 fw-bold " style="color:#06428b ">200</div>
                                </div>

                                <!-- Đã xử lý -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="text-success fw-semibold">Đã xử lý</div>
                                    <div class="text-success fw-bold">120 (85.7%)</div>
                                </div>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: 85.7%"></div>
                                </div>

                                <!-- Chưa xử lý -->
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <div class="text-warning fw-semibold">Chưa xử lý</div>
                                    <div class="text-warning fw-bold">20 (14.3%)</div>
                                </div>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 14.3%"></div>
                                </div>

                                <!-- Tỷ lệ hoàn thành -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted">Tỷ lệ hoàn thành</div>
                                    <div class="fw-bold text-primary">85.7%</div>
                                </div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar bg-primary" role="progressbar" style="width: 85.7%"></div>
                                </div>
                            </div>
                        </div>
                    </div>*@

                </div>
            </div>
            <div class="container py-4 @d_none">
                <!-- Biểu đồ trên -->
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">Biểu đồ theo thời gian</div>
                            <div class="card-body">
                                <canvas id="lineChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">Top Nhật ký sản xuất</div>
                            <div class="card-body">
                                <canvas id="barHorizontalChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card">
                            <div class="card-header">Top Biên bản giao nhận</div>
                            <div class="card-body">
                                <canvas id="barHorizontalChartBB"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Biểu đồ dưới -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-body" style="min-height: 350px;max-height:500px">
                                <canvas id="barChart"></canvas>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <script>
                let myBarChart = null; // Biến toàn cục
                function GetValueTong(){
                    const thang = $('#thang').val(); // định dạng yyyy-MM

                    $.ajax({
                        url: '/Home/GetDataTong', // ← Controller Action trả về Json
                        type: 'GET',
                        data: { thang: thang },
                        success: function (res) {
                            //console.log("Dữ liệu nhận về:", res.Tong_BBGN);
                            // BBGN
                            $('#TongBBGN').text(res.Tong_BBGN);
                            $('#TongSanLuongBBGN').text(res.TongSanLuong_BBGN);
                            var tileDaXuLy = res.Tong_BBGN != 0 ? (res.DaXuLy_BBGN * 100) / res.Tong_BBGN : 0;
                            var tileChuaXuLy = 100 - tileDaXuLy;
                            $('#TiLeDaXuLyBBGN').text(`${res.DaXuLy_BBGN} / (${tileDaXuLy} % )`);
                            $('#TiLeDXLBBGN').width(`${tileDaXuLy}%`);
                            $('#TiLeChuaXuLyBBGN').text(`${res.ChuaXuLy_BBGN} / (${tileChuaXuLy} % )`);
                            $('#TiLeCXLBBGN').width(`${tileChuaXuLy}%`);
                            // Nhat ky san xuat
                            $('#TongNK').text(res.Tong_NK);
                            $('#TongThoiGianNK').text(res.TongSanLuong_NK);
                            var tileDaXuLyNK = res.Tong_NK != 0 ? (res.DaXuLy_NK * 100) / res.Tong_NK : 0;
                            var tileChuaXuLyNK = 100 - tileDaXuLyNK;
                            $('#TiLeDaXuLyNK').text(`${res.DaXuLy_NK} / (${tileDaXuLyNK} % )`);
                            $('#TiLeDXLNK').width(`${tileDaXuLyNK}%`);
                            $('#TiLeChuaXuLyNK').text(`${res.ChuaXuLy_NK} / (${tileChuaXuLyNK} % )`);
                            $('#TiLeCXLNK').width(`${tileChuaXuLyNK}%`);
                            //updateChart(res.labels, res.datasets);
                        },
                        error: function () {
                            alert("Lỗi khi lấy dữ liệu tháng.");
                        }
                    });
                    // Get Ds phong Ban
                    $.ajax({
                        url: '/Home/GetBienBan',
                        method: 'GET',
                        data: { thang: thang },
                        success: function (res) {
                            // Hủy biểu đồ cũ nếu tồn tại
                            if (myBarChart) {
                                myBarChart.destroy();
                            }
                            myBarChart =   new Chart(document.getElementById("barChart"), {
                                type: 'bar',
                                //data: {
                                //    labels: res.labels,
                                //    datasets: res.datasets
                                //},
                                data: {
                                    labels: res.labels,
                                    datasets: [
                                        {
                                            label: 'Biên bản giao nhận nguyên nhiên vật tư',
                                            data: res.datasets[0].data,
                                            backgroundColor: '#0d6efd'
                                        },
                                        {
                                            label: 'Biên bản nhật ký dừng sản xuất',
                                            data: res.datasets[1].data,
                                            backgroundColor: '#06428b'
                                        }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            position: 'top',
                                        },
                                        title: {
                                            display: true,
                                            text: 'Thống kê Biên bản theo bộ phận'
                                        }
                                    }
                                },
                            });
                        },
                        error: function () {
                            alert("Không thể tải dữ liệu biểu đồ");
                        }
                    });
                }
                GetValueTong();
                $(document).ready(function () {
                    // get DS Tong
                    $('#formChonThang').submit(function (e) {
                        e.preventDefault(); 
                        GetValueTong();
                    });
                   
                    $.ajax({
                        url: '/Home/GetPhieuTuan',
                        method: 'GET',
                        success: function (res) {
                            new Chart(document.getElementById("lineChart"), {
                                type: 'line',
                                data: {
                                    labels: res.labels,
                                    datasets: res.datasets
                                },
                                options: {
                                    responsive: true,
                                    //maintainAspectRatio: false,
                                    plugins: {
                                        legend: { position: 'top' },
                                        title: {
                                            display: true,
                                            text: 'Biểu đồ biên bản vs nhật ký dừng máy'
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        },
                        error: function () {
                            alert("Không thể tải dữ liệu biểu đồ");
                        }
                    });
                    // top 5 nhat ky
                    $.ajax({
                        url: '/Home/GetTopPhongBanNK',
                        method: 'GET',
                        success: function (res) {
                            const labels = res.map(x => x.tenPhongBan);
                            const values = res.map(x => x.soLuongPhieu);
                            new Chart(document.getElementById("barHorizontalChart"), {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [
                                    {
                                        label: 'Nhật ký dừng sản xuất',
                                            data: values,
                                        backgroundColor: '#0d6efd'
                                    }]
                                },
                                options: {
                                    indexAxis: 'y'
                                }
                            });
                        },
                        error: function () {
                            alert("Không thể tải dữ liệu biểu đồ");
                        }
                    });

                    $.ajax({
                        url: '/Home/GetTopPhongBanBBGN',
                        method: 'GET',
                        success: function (res) {
                            const labels = res.map(x => x.tenPhongBan);
                            const values = res.map(x => x.soLuongPhieu);
                            new Chart(document.getElementById("barHorizontalChartBB"), {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [
                                        {
                                            label: 'Nhật ký dừng sản xuất',
                                            data: values,
                                            backgroundColor: '#0d6efd'
                                        }]
                                },
                                options: {
                                    indexAxis: 'y'
                                }
                            });
                        },
                        error: function () {
                            alert("Không thể tải dữ liệu biểu đồ");
                        }
                    });

                });

                // Thanh ngang: Phiếu theo phòng ban
                //new Chart(document.getElementById("barHorizontalChart"), {
                //  type: 'bar',
                //  data: {
                //    labels: ['P.KH', 'P.TB', 'NM.HRC1', 'NM.Luyện thép', 'P.IT&DX'],
                //    datasets: [{
                //      label: 'Biên bản giao nhận',
                //      data: [15, 25, 35, 40, 20],
                //      backgroundColor: '#06428b'
                //    },
                //        {
                //            label: 'Nhật ký dừng sản xuất',
                //            data: [15, 25, 35, 40, 20],
                //            backgroundColor: '#0d6efd'
                //        }]
                //  },
                //  options: {
                //    indexAxis: 'y'
                //  }
                //});
            </script>

        </div>
    </section>
</div>
