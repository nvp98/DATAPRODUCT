@using Data_Product.Models
@using System.Security.Claims;
@using Data_Product.Repositorys;
@using Microsoft.EntityFrameworkCore;
@inject Data_Product.Repositorys.DataContext _context
@model List<Tbl_BM_16_GangLong>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="~/Content/assets/Chonse/chosen.jquery.js"></script>
<link href="~/Content/assets/Chonse/chosen.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
	table th {
	text-align: center;
	}

	#dataTable input {
	border-radius: 0px !important;
	}

	th.toggle-col, td.toggle-col {
	display: none;
	}
</style>
@if (TempData["msgSuccess"] != null)
{
	@Html.Raw(TempData["msgSuccess"])
}
@if (TempData["msgError"] != null)
{
	@Html.Raw(TempData["msgError"])
}
@{
	ViewData["Title"] = "Index";
	Layout = "~/Views/Shared/_Layout.cshtml";

	Pager pager = new Pager();
	int pageNo = 0;
	if (ViewBag.Pager != null)
	{
		pager = ViewBag.Pager;
		pageNo = pager.CurrentPage;
	}
}
@using (Html.BeginForm("TaoPhieu", "BM16_GangThoi", FormMethod.Post, new { enctype = "multipart/form-data", id = "TaoPhieu" }))
{
	<div class="app-main__outer">
		<div class="app-main__inner" style="display:block;padding-bottom: 0px;">
			<div id="alertContainer" class="mt-3"></div>
			<div class="row">
				<div class="col mb-3">
					<label class="form-label">Mã phiếu:</label>
					<input type="text" class="form-control" value="@ViewBag.MaPhieu" readonly id="PhieuID" />
				</div>

				<div class="col mb-3">
					<label class="form-label">Ngày:</label>
					 <input type="date" class="form-control" value="@ViewBag.Ngay" readonly id="ID_Day" /> 
				</div>

				<div class="col mb-3">
					<label class="form-label">Tên kíp:</label>
					<input type="text" class="form-control" value="@ViewBag.TenKip" readonly id="IDKip"/>
				</div>

				<div class="col mb-3">
					<label class="form-label">Tên ca:</label>
					<input type="text" class="form-control" value="@ViewBag.TenCa" readonly id="IDCa"/>
				</div>

				<div class="col mb-3">
					<label class="form-label">Tên lò cao:</label>
					<input type="text" class="form-control" value="@ViewBag.ID_Locao" readonly id="ID_Locao" />
				</div>
				<div class="col mb-3" hidden>
					<input type="text" class="form-control" value="@ViewBag.ID_Kip" readonly id="ID_Kip" />
				</div>
			</div>
			<div class="tab-content">
				<div class="row">
					<div class="card-body" style="padding-top: 0%; overflow-x: auto; font-size: 14px;">
						<div class="row w-100 justify-content-end mb-3">
							<div class="col-auto">
								<button type="button" id="btnLuuThungMoi" class="btn btn-primary">
									<i class="fa fa-save"></i> Lưu các thùng mới
								</button>

								<button type="button" class="btn btn-secondary" id="btnLamMoi">
									<i class="bi bi-arrow-clockwise"></i>
									<span class="small pt-2 ps-1 text-white">Làm mới</span>
								</button>
								<button type="button" class="btn btn-success me-2">
									<i class="bi bi-arrow-right-circle"></i> Chuyển
								</button>
								<button type="button" class="btn btn-danger">
									<i class="bi bi-arrow-counterclockwise"></i> Thu hồi
								</button>
								<button id="toggleColumnsBtn" type="button" class="btn btn-outline-secondary btn-sm mb-2">
									Ẩn/Hiện
								</button>
							</div>
						</div>
						<div class="table-responsive" style="height: auto;">
							<table class="table table-bordered table-hover align-middle text-center" id="dataTable">
								<thead class="table-light">
									<tr>
										<th rowspan="2">Xóa</th>
										<th rowspan="2">Copy thùng</th>
										<th rowspan="2">Mã thùng</th>
										<th rowspan="2">Số mẻ</th>
										<th rowspan="2">Thùng số</th>
										<th rowspan="2">Giờ</th>
										<th rowspan="2">Phân loại</th>
										<th rowspan="2">KL xe goong</th>
										<th rowspan="2">KL thùng</th>
										<th rowspan="2">KL thùng & gang lỏng</th>
										<th rowspan="2">KL gang lỏng cân ray</th>
										<th colspan="4">Vận chuyển đến</th>
										<th rowspan="2">Giờ NM</th>
										<th rowspan="2">Ghi chú</th>									
										<th rowspan="2">
											<div style="font-size: 12px;">Chọn thùng</div>
											<input type="checkbox" id="selectAll" class="form-check-input" style="width: 20px; height: 20px;" title="Chọn tất cả">
										</th>
										<th rowspan="2">Tình trạng</th>
										<th rowspan="2" class="toggle-col">Người nhận 1</th>
										<th rowspan="2" class="toggle-col">BP nhận 1</th>
										<th rowspan="2" class="toggle-col">Người nhận 2</th>
										<th rowspan="2" class="toggle-col">BP nhận 2</th>
										<th rowspan="2" class="toggle-col">Chốt thùng</th>
									</tr>
									<tr>
										<th>NM.HRC1</th>
										<th>NM.HRC2</th>
										<th>Đúc1</th>
										<th>Đúc2</th>
									</tr>
								</thead>
								<tbody>
									@if (ViewBag.DanhSachThung != null)
									{
										foreach (var item in ViewBag.DanhSachThung)
										{
											<tr>
												<td class='text-center delItem'>
													<a class="btn btn-danger btn-sm" title="Xóa">
														<i class="bi bi-trash"></i>
													</a>
												</td>
												<td class='text-center copyItem'>
													<a class="btn btn-primary btn-sm btn-edit-thung" title="Chỉnh sửa thùng"
													   data-bs-toggle="modal" data-bs-target="#editThungModal">
														<i class="bi bi-copy"></i>
													</a>
												</td>
												<td name="maThung" >@item.MaThung</td>
												<td name="soMe">@item.SoMe</td>
												<td name="ThungSo">@item.ThuTuThung</td>
												<td name="Gio">@item.GioNhaMay</td>
												<td name ="PhanLoai">@item.PhanLoai</td>
												<td>
													<input type="number" name="KhoiLuongXeGoong" class="form-control" value="@item.KL_XeGoong" style="width: 70px; padding: 1px; " disabled />
												</td>
												<td>
													<input id="KLThung_${index}" name="KhoiLuongThung" type="number" step="0.01" min="0.01" class="form-control" value="@item.KL_Thung" style="width: 100px; padding: 4px;">
												</td>
												<td>
													<input id="KLThungGL_${index}" name="KLThungGangLong" type="number" step="0.01" min="0.01" class="form-control" value="@item.KL_Thung_GangLong" style="width: 100px; padding: 4px;">
												</td>
												<td>
													<input id="KLGLCR_${index}" name="KLGangLong" type="number" step="0.01" min="0.01" class="form-control" value="@item.KL_GangLong_CanRay" style="width: 100px; padding: 4px;">
												</td>
												<td><input type="checkbox" @(item.DenHRC1 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenHRC2 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenDuc1 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenDuc2 ? "checked" : "") disabled /></td>
												<td>@item.GioNM</td>
												<td><textarea name="GhiChu" class="form-control" rows="2" value="@item.GhiChu" style="width: 100px; resize: none; padding: 4px;"></textarea></td>
												<td><input type="checkbox" class="chon-thung-checkbox"/></td>
												<td>
													@if (item.DaChuyen)
													{
														<button class="btn btn-danger btn-sm">Chưa chuyển</button>
													}
													else
													{
														<button class="btn btn-success btn-sm">Đã chuyển</button>
													}
												</td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col">
													@if (item.TrangThai == 1)
													{
														<button class="btn btn-danger btn-sm">Chưa chuyển</button>
													}
													else if (item.TrangThai == 2)
													{
														<button class="btn btn-warning btn-sm">Chờ xử lý</button>
													}
													else
													{
														<button class="btn btn-success btn-sm">Đã chốt</button>
													}
												</td>
											</tr>
										}
									}
								</tbody>
							</table>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>
}
<!-- Modal -->
<div class="modal fade" id="editThungModal" tabindex="-1" aria-labelledby="editThungModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editThungModalLabel">Chỉnh sửa thùng</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
			</div>
			<div class="modal-body">
				<input type="hidden" id="modalMaThungHidden" />

				<div class="row">
					<!-- Cột trái -->
					<div class="col-md-6">
						<div class="form-group mb-3">
							<label for="modalMaThung">Mã thùng</label>
							<input type="text" id="modalMaThung" class="form-control" />
						</div>

						<div class="form-group mb-3">
							<label for="modalSoMe">Số mẻ</label>
							<input type="text" id="modalSoMe" class="form-control" />
						</div>

						<div class="form-group mb-3">
							<label for="modalGio">Giờ</label>
							<input type="time" id="modalGio" class="form-control" />
						</div>

						<div class="form-group mb-3">
							<label for="modalPhanLoai">Phân loại</label>
							<input type="text" id="modalPhanLoai" class="form-control" />
						</div>

						<div class="form-group mb-3">
							<label for="modalKLXeGoong">KL xe goong</label>
							<input type="number" id="modalKLXeGoong" class="form-control" step="0.01" />
						</div>

						<div class="form-group mb-3">
							<label for="modalKLThung">KL thùng</label>
							<input type="number" id="modalKLThung" class="form-control" step="0.01" />
						</div>
					</div>

					<!-- Cột phải -->
					<div class="col-md-6">
						<div class="form-group mb-3">
							<label for="modalKLThungGangLong">KL thùng & gang lỏng</label>
							<input type="number" id="modalKLThungGangLong" class="form-control" step="0.01" />
						</div>

						<div class="form-group mb-3">
							<label for="modalKLGangLong">KL gang lỏng</label>
							<input type="number" id="modalKLGangLong" class="form-control" step="0.01" />
						</div>

						<div class="form-group mb-3">
							<label class="form-label">Vận chuyển đến</label>
							<div class="row">
								<div class="col-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="checkboxHRC1">
										<label class="form-check-label" for="checkboxHRC1">HRC1</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="checkboxHRC2">
										<label class="form-check-label" for="checkboxHRC2">HRC2</label>
									</div>
								</div>
								<div class="col-6">
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="checkboxDUC1">
										<label class="form-check-label" for="checkboxDUC1">Đúc 1</label>
									</div>
									<div class="form-check">
										<input class="form-check-input" type="checkbox" id="checkboxDUC2">
										<label class="form-check-label" for="checkboxDUC2">Đúc 2</label>
									</div>
								</div>
							</div>
						</div>

						<div class="form-group mb-3">
							<label for="modalGioNM">Giờ NM</label>
							<input type="time" id="modalGioNM" class="form-control" />
						</div>

						<div class="form-group mb-3">
							<label for="modalGhiChu">Ghi chú</label>
							<textarea id="modalGhiChu" class="form-control" rows="2" style="resize: none;"></textarea>
						</div>
					</div>
				</div>
			</div>

			<div class="modal-footer">
				<button type="button" id="btnLuuThung" class="btn btn-primary">Lưu</button>
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
			</div>
		</div>
	</div>
</div>

<script>
	$(document).ready(function()
	{
		// Chọn/bỏ chọn tất cả
		$('#selectAll').change(function() {
			$('.chon-thung-checkbox').prop('checked', $(this).prop('checked'));
		});

		// Kiểm tra trạng thái checkbox
		$('.chon-thung-checkbox').change(function() {
			const allChecked = $('.chon-thung-checkbox').length === $('.chon-thung-checkbox:checked').length;
			$('#selectAll').prop('checked', allChecked);
		});

		// Nút chuyển thùng
		$('.btn-success').click(function() {
			const selectedIds = [];
			console.log("======",selectedIds)
			$('.chon-thung-checkbox:checked').each(function() {
				const row = $(this).closest('tr');
				const maThung = row.find('td:eq(2)').text();
				const daChuyen = row.find('td:eq(17)').find('button').hasClass('btn-success');

				if (daChuyen) {
					alert(`Thùng ${maThung} đã được chuyển trước đó`);
					return false;
				}

				selectedIds.push(maThung);
			});

			if (selectedIds.length === 0) {
				alert('Vui lòng chọn ít nhất một thùng');
				return;
			}

			if (confirm(`Bạn có chắc chắn muốn chuyển ${selectedIds.length} thùng đã chọn?`)) {
				chuyenThung(selectedIds);
			}
		});

		// Nút thu hồi thùng
		$('.btn-danger').click(function() 
		{
			const selectedMaThungs = [];
			console.log("======",selectedMaThungs)
			$('.chon-thung-checkbox:checked').each(function () {
				const row = $(this).closest('tr');
				const maThung = row.find('td:eq(2)').text(); // Cột chứa mã thùng gang
			selectedMaThungs.push(maThung);
			});

			if (selectedMaThungs.length === 0) 
			{
				alert('Vui lòng chọn ít nhất một thùng để thu hồi');
				return;
			}

			if (confirm(`Bạn có chắc chắn muốn thu hồi ${selectedMaThungs.length} thùng đã chọn?`)) 
			{
				thuHoiThung(selectedMaThungs);
			}
		});

		// Ẩn/hiện cột
		let isHidden = true;
		$('#toggleColumnsBtn').on('click', function() {
			if (isHidden) {
				$('th.toggle-col, td.toggle-col').show();
			} else {
				$('th.toggle-col, td.toggle-col').hide();
			}
			isHidden = !isHidden;
		});
		$("#btnLamMoi").click(function() {
		loadThemSoMeMoi();
		});
		 $("#btnLuuThungMoi").click(function () {
			saveGangThoiVaoPhieu();
			
		});

	});

	// Hàm gọi API chuyển thùng
	function chuyenThung(dsthung) 
		{
			$.ajax({
				url: '@Url.Action("ChuyenThung", "BM16_GangThoi")',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(dsthung),
				success: function(response) {
					if (response.success) {
						alert(response.message);
						location.reload();
					} else {
						alert(response.message);
					}
				},
				error: function() {
					alert('Có lỗi xảy ra khi gửi yêu cầu');
				}
			});
		}
	function thuHoiThung(dsMaThung) 
		{
			$.ajax({
				url: '@Url.Action("ThuHoiThung", "BM16_GangThoi")',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(dsMaThung),
				success: function (response) {
					   showAlert(response.message, response.success ? 'success' : 'danger');
						if (response.success) {
						  setTimeout(() => {
							location.reload();
						  }, 2000); // Đợi 2s cho người dùng đọc alert
						}
					  },
					  error: function () {
						showAlert('Có lỗi xảy ra khi gửi yêu cầu thu hồi thùng', 'danger');
					  }
					});
		}
	function showAlert(message, type) {
		const alertHtml = `
		<div class="alert alert-${type} alert-dismissible fade show" role="alert">
			${message}
			<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>
		</div>
		`;
		const alertContainer = document.getElementById('alertContainer');
		alertContainer.innerHTML = alertHtml;

		// Tự động ẩn sau 5 giây
		setTimeout(() => {
		const alert = alertContainer.querySelector('.alert');
		if (alert) {
			alert.classList.remove('show');
			alert.classList.add('hide');
		}
		}, 5000);
	}
					// Hàm tạo mã thùng
	function generateMaThung(dateStr, loCao, ca, stt) {
			const date = new Date(dateStr);
			const dd = String(date.getDate()).padStart(2, '0');
			const mm = String(date.getMonth() + 1).padStart(2, '0');
			const yy = String(date.getFullYear()).slice(-2);
			const caChar = (ca === '1') ? 'N' : 'D';
			const sttFormatted = String(stt).padStart(3, '0');

			return `${dd}${mm}${yy}L${loCao}${caChar}${sttFormatted}.00`;
	}
	function getLastThungIndex() {
		let maxIndex = 0;
		$("#dataTable tbody td[name='maThung']").each(function () {
			let ma = $(this).text().trim();
			let match = ma.match(/(\d{3})\.00$/); // match số cuối
			if (match) {
				let num = parseInt(match[1]);
				if (num > maxIndex) {
					maxIndex = num;
				}
			}
		});
		return maxIndex;
	}

		function loadThemSoMeMoi() {
		let ngay = $("#ID_Day").val();
		let idLoCao = $("#ID_Locao").val();
		let idKip = $("#ID_Kip").val();

		$.ajax({
			url: "/BM16_GangThoi/GetSoMeGangBKMis",
			type: "GET",
			data: {
				ngay: ngay,
				ID_LoCao: idLoCao,
				IDKip: idKip
			},
			success: function (data) {
				let tableBody = $("#dataTable tbody");
				let soMeHienTai = [];

				tableBody.find("td[name='soMe']").each(function () {
					soMeHienTai.push($(this).text().trim());
				});

				let index = tableBody.find("tr").length;
				let lastIndex = getLastThungIndex();

				//  LẤY KL XE
				$.ajax({
					url: "/XeGoong/KLXeLoCao",
					type: 'GET',
					data: { idlocao: idLoCao },
					success: function (xeData) {
						console.log('xe', xeData);
						let klxe = (xeData.success && xeData.klXe) ? xeData.klXe : "";

						// đặt forEach bên trong success này
						data.forEach((item, i) => {
							let soMe = item.testPatternCode || "";
							if (!soMeHienTai.includes(soMe)) {
								lastIndex++;
								let maThung = generateMaThung(ngay, idLoCao, idKip, lastIndex);
								let thungSo = soMe.length >= 2 ? soMe.slice(-2) : "";
								let phanLoai = item.classifyName || "";
								let time = item.patterntime ? item.patterntime.replace(/H/g, ":") : "";

								let row = `
									<tr class="row-new" data-new="true">
										<td class='text-center delItem'><a class="btn btn-danger btn-sm"><i class="bi bi-trash"></i></a></td>
										<td class='text-center copyItem'><a class="btn btn-secondary btn-sm copyRowBtn"><i class="bi bi-copy"></i></a></td>
										<td name="maThung">${maThung}</td>
										<td name="soMe">${soMe}</td>
										<td name="ThungSo">${thungSo}</td>
										<td name="Gio">${time}</td>
										<td name="PhanLoai">${phanLoai}</td>
											<td><input type="number" name="KhoiLuongXeGoong" class="form-control" value="${klxe}" style="width: 100px;" required></td>
											<td><input id="KLThung_${index}" name="KhoiLuongThung" type="number" class="form-control" value="" style="width: 100px;" required></td>
											<td><input id="KLThungGL_${index}" name="KLThungGangLong" type="number" class="form-control" value="" style="width: 100px;"required></td>
										<td><input id="KLGLCR_${index}" name="KLGangLong" type="number" class="form-control" value="" style="width: 100px;"></td>
										<td><input type="checkbox" name="VanChuyenHRC1" class="form-check-input"></td>
										<td><input type="checkbox" name="VanChuyenHRC2" class="form-check-input"></td>
										<td><input type="checkbox" name="VanChuyenDUC1" class="form-check-input"></td>
										<td><input type="checkbox" name="VanChuyenDUC2" class="form-check-input"></td>
										<td>${time}</td>
										<td><textarea name="GhiChu" class="form-control" style="width: 100px;"></textarea></td>
										<td><input type="checkbox" class="chon-thung-checkbox"/></td>
										<td></td>
										<td class="toggle-col"></td>
										<td class="toggle-col"></td>
										<td class="toggle-col"></td>
										<td class="toggle-col"></td>
										<td class="toggle-col"></td>
									</tr>`;
								tableBody.append(row);
								index++;
							}
						});
					},
					error: function () {
						alert("Không thể lấy khối lượng xe goòng.");
					}
				});
			},
			error: function () {
				alert("Không thể lấy dữ liệu BKMIS.");
			}
		});
	}

	function saveGangThoiVaoPhieu() {
    let phieuID = $("#PhieuID").val();
    let idLoCao = $("#ID_Locao").val();
    let idKip = $("#ID_Kip").val();
    let danhSachThung = [];

    $("#dataTable tbody tr[data-new='true']").each(function () {
        let row = $(this);
			 let vanChuyenHRC1 = row.find("input[name='VanChuyenHRC1']").is(":checked");
		let vanChuyenHRC2 = row.find("input[name='VanChuyenHRC2']").is(":checked");
		let vanChuyenDUC1 = row.find("input[name='VanChuyenDUC1']").is(":checked");
		let vanChuyenDUC2 = row.find("input[name='VanChuyenDUC2']").is(":checked");

		// Xác định nơi chuyển đến
		let chuyenDen = vanChuyenHRC1 ? "HRC1" :
						vanChuyenHRC2 ? "HRC2" :
						vanChuyenDUC1 ? "DUC1" :
						vanChuyenDUC2 ? "DUC2" :
						"KHONG_XAC_DINH";
        danhSachThung.push({
            MaThungGang: row.find("td[name='maThung']").text().trim(),
            BKMIS_SoMe: row.find("td[name='soMe']").text().trim(),
            BKMIS_ThungSo: row.find("td[name='ThungSo']").text().trim(),
            BKMIS_Gio: row.find("td[name='Gio']").text().trim(),
            BKMIS_PhanLoai: row.find("td[name='PhanLoai']").text().trim(),
            KL_XeGoong: parseFloat(row.find("input[name='KhoiLuongXeGoong']").val()) || 0,
            G_KLThungChua: parseFloat(row.find("input[name='KhoiLuongThung']").val()) || 0,
            G_KLThungVaGang: parseFloat(row.find("input[name='KLThungGangLong']").val()) || 0,
            G_KLGangLong: parseFloat(row.find("input[name='KLGangLong']").val()) || 0,
			ChuyenDen: chuyenDen,
            G_GhiChu: row.find("textarea[name='GhiChu']").val()
        });
    });

    // Tạo object gửi lên controller
    const dataToSend = {
        MaPhieu: phieuID,
        ID_LoCao: parseInt(idLoCao),
        ID_Kip: parseInt(idKip),
        DanhSachThung: danhSachThung
    };

    console.log("=== data gửi lên ===", dataToSend);

    $.ajax({
        url: "/BM16_GangThoi/SaveThung",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(dataToSend),
        success: function (res) {
            alert(res.message || "Lưu thành công!");
			location.reload();
        },
        error: function (err) {
            alert("Lỗi khi lưu: " + err.responseText);
        }
    });
}
	$(document).on("input", "input[id^='KLThung_'], input[id^='KLThungGL_']", function () {
			let index = $(this).attr("id").split("_")[1];
			let klThung = parseFloat($("#KLThung_" + index).val()) || 0;
			let klThungGL = parseFloat($("#KLThungGL_" + index).val()) || 0;

			let klGLCR = (klThungGL - klThung) ? parseFloat((klThungGL - klThung).toFixed(2)) : 0;

			$("#KLGLCR_" + index).val(klGLCR);
		});
	$(document).ready(function() {
		function tinhTongKL() {
			let tong = 0;

			$('input[name="KLGangLong"]').each(function() {
				let val = parseFloat($(this).val());
				if (!isNaN(val)) {
					tong += val;
				}
			});

			$('#dataTable tbody tr.tong-row').remove();

		let tongRow = `
			<tr class="tong-row" style="font-weight:bold; background-color:#f0f0f0;">
				<td></td>
				<td></td>
				<td class="text-end">Tổng KL</td> <!-- Cột 3 -->
				<td colspan="7"></td>
				<td>${tong.toFixed(2)}</td> <!-- KL gang lỏng cân ray -->
				<td colspan="14"></td>
			</tr>
		`;

			$('#dataTable tbody').append(tongRow);
		}
		tinhTongKL();
			});
	$(document).on('click', '.btn-edit-thung', function () {
		const row = $(this).closest('tr');

		const data = {
			maThung: row.find('td:eq(2)').text().trim(),
			soMe: row.find('td:eq(3)').text().trim(),
			gio: row.find('td:eq(5)').text().trim(),
			phanLoai: row.find('td:eq(6)').text().trim(),
			klXeGoong: parseFloat(row.find('td:eq(7) input').val()) || 0,
			klThung: parseFloat(row.find('td:eq(8) input').val()) || 0,
			klThungVaGang: parseFloat(row.find('td:eq(9) input').val()) || 0,
			klGangLong: parseFloat(row.find('td:eq(10) input').val()) || 0,
			gioNM: row.find('td:eq(15)').text().trim(),
			ghiChu: row.find('td:eq(16)').text().trim(),

			chuyenDen: '',

		};

		// Ghép chuyển đến dựa vào checkbox:
		const den = [];
		if (row.find('td:eq(11) input').is(':checked')) den.push('HRC1');
		if (row.find('td:eq(12) input').is(':checked')) den.push('HRC2');
		if (row.find('td:eq(13) input').is(':checked')) den.push('DUC1');
		if (row.find('td:eq(14) input').is(':checked')) den.push('DUC2');
		data.chuyenDen = den.join(',');

		console.log("DATA:", data);
				// Gán vào biến toàn cục
		window.thungData = data;

		console.log("window.thungData = data;",window.thungData = data)
		// Đổ dữ liệu vào modal
		$('#modalMaThungHidden').val(data.maThung);
		$('#modalMaThung').val(data.maThung).prop('disabled', true);
		$('#modalSoMe').val(data.soMe).prop('disabled', true);
		$('#modalGio').val(data.gio).prop('disabled', true);
		$('#modalPhanLoai').val(data.phanLoai).prop('disabled', true);

		$('#modalKLGangLong').val(data.klGangLong);
		$('#modalKLThung').val(data.klThung);
		$('#modalKLThungGangLong').val(data.klThungVaGang);
		$('#modalKLXeGoong').val(data.klXeGoong);
		$('#modalGioNM').val(data.gioNM);
		$('#modalGhiChu').val(data.ghiChu);

		// Set checkbox
		const cdList = data.chuyenDen.split(',');
		$('#checkboxHRC1').prop('checked', cdList.includes('HRC1'));
		$('#checkboxHRC2').prop('checked', cdList.includes('HRC2'));
		$('#checkboxDUC1').prop('checked', cdList.includes('DUC1'));
		$('#checkboxDUC2').prop('checked', cdList.includes('DUC2'));

		$('#editThungModal').modal('show');
		});
		$('#btnLuuThung').on('click', function () {
		if (!window.thungData) {
			alert("Không có dữ liệu thùng để lưu.");
			return;
		}

		// Cập nhật dữ liệu từ modal (nếu có sửa)
		window.thungData.MaThungGang = $('#modalMaThung').val().trim();
		window.thungData.KL_XeGoong = parseFloat($('#modalKLXeGoong').val()) || 0;
		window.thungData.G_KLThungChua = parseFloat($('#modalKLThung').val()) || 0;
		window.thungData.G_KLThungVaGang = parseFloat($('#modalKLThungGangLong').val()) || 0;
		window.thungData.G_KLGangLong = parseFloat($('#modalKLGangLong').val()) || 0;
		window.thungData.G_GhiChu = $('#modalGhiChu').val().trim();
		window.thungData.Gio_NM = $('#modalGioNM').val().trim();
		window.thungData.ChuyenDen = [
			$('#checkboxHRC1').is(':checked') ? 'HRC1' : '',
			$('#checkboxHRC2').is(':checked') ? 'HRC2' : '',
			$('#checkboxDUC1').is(':checked') ? 'DUC1' : '',
			$('#checkboxDUC2').is(':checked') ? 'DUC2' : ''
		].filter(x => x).join(',');
			console.log('window.thungData',window.thungData)
		$.ajax({
			url: '/BM16_GangThoi/EditThung',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify(window.thungData),
			success: function (res) {
				if (res.success) {
					alert('✅ ' + res.message);
					location.reload();
				} else {
					alert('❌ ' + res.message);
				}
			},
			error: function (err) {
				console.error("Lỗi gọi API EditThung:", err);
				alert('❌ Lỗi máy chủ khi lưu.');
			}
		});
	});

</script>