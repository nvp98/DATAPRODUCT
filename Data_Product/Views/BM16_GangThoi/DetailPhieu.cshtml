@using Data_Product.Models
@using System.Security.Claims;
@using Data_Product.Repositorys;
@using Microsoft.EntityFrameworkCore;
@inject Data_Product.Repositorys.DataContext _context
@model List<Tbl_BM_16_GangLong>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="~/Content/assets/Chonse/chosen.jquery.js"></script>
<link href="~/Content/assets/Chonse/chosen.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
	table th {
	text-align: center;
	}

	#dataTable input {
	border-radius: 0px !important;
	}

	th.toggle-col, td.toggle-col {
	display: none;
	}
</style>
@if (TempData["msgSuccess"] != null)
{
	@Html.Raw(TempData["msgSuccess"])
}
@if (TempData["msgError"] != null)
{
	@Html.Raw(TempData["msgError"])
}
@{
	ViewData["Title"] = "Index";
	Layout = "~/Views/Shared/_Layout.cshtml";

	Pager pager = new Pager();
	int pageNo = 0;
	if (ViewBag.Pager != null)
	{
		pager = ViewBag.Pager;
		pageNo = pager.CurrentPage;
	}
}
@using (Html.BeginForm("TaoPhieu", "BM16_GangThoi", FormMethod.Post, new { enctype = "multipart/form-data", id = "TaoPhieu" }))
{
	<div class="app-main__outer">
		<div class="app-main__inner" style="display:block;padding-bottom: 0px;">
			<div id="alertContainer" class="mt-3"></div>
			<div class="tab-content">
				<div class="row">
					<div class="card-body" style="padding-top: 0%; overflow-x: auto; font-size: 14px;">
						<div class="row w-100 justify-content-end mb-3">
							<div class="col-auto">
								<button type="button" class="btn btn-success me-2">
									<i class="bi bi-arrow-right-circle"></i> Chuyển
								</button>
								<button type="button" class="btn btn-danger">
									<i class="bi bi-arrow-counterclockwise"></i> Thu hồi
								</button>
								<button id="toggleColumnsBtn" type="button" class="btn btn-outline-secondary btn-sm mb-2">
									Ẩn/Hiện
								</button>
							</div>
						</div>
						<div class="table-responsive" style="height: auto;">
							<table class="table table-bordered table-hover align-middle text-center" id="dataTable">
								<thead class="table-light">
									<tr>
										<th rowspan="2">Xóa</th>
										<th rowspan="2">Copy thùng</th>
										<th rowspan="2">Mã thùng</th>
										<th rowspan="2">Số mẻ</th>
										<th rowspan="2">Thùng số</th>
										<th rowspan="2">Giờ</th>
										<th rowspan="2">Phân loại</th>
										<th rowspan="2">KL xe goong</th>
										<th rowspan="2">KL thùng</th>
										<th rowspan="2">KL thùng & gang lỏng</th>
										<th rowspan="2">KL gang lỏng cân ray</th>
										<th colspan="4">Vận chuyển đến</th>
										<th rowspan="2">Giờ NM</th>
										<th rowspan="2">Ghi chú</th>									
										<th rowspan="2">
											<div style="font-size: 12px;">Chọn thùng</div>
											<input type="checkbox" id="selectAll" class="form-check-input" style="width: 20px; height: 20px;" title="Chọn tất cả">
										</th>
										<th rowspan="2">Tình trạng</th>
										<th rowspan="2" class="toggle-col">Người nhận 1</th>
										<th rowspan="2" class="toggle-col">BP nhận 1</th>
										<th rowspan="2" class="toggle-col">Người nhận 2</th>
										<th rowspan="2" class="toggle-col">BP nhận 2</th>
										<th rowspan="2" class="toggle-col">Chốt thùng</th>
									</tr>
									<tr>
										<th>NM.HRC1</th>
										<th>NM.HRC2</th>
										<th>Đúc1</th>
										<th>Đúc2</th>
									</tr>
								</thead>
								<tbody>
									@if (ViewBag.DanhSachThung != null)
									{
										foreach (var item in ViewBag.DanhSachThung)
										{
											<tr>
												<td class='text-center delItem'>
													<a class="btn btn-danger btn-sm" title="Xóa">
														<i class="bi bi-trash"></i>
													</a>
												</td>
												<td class='text-center copyItem'>
													<a class="btn btn-secondary btn-sm copyRowBtn" title="Copy dòng">
														<i class="bi bi-copy"></i>
													</a>
												</td>
												<td>@item.MaThung</td>
												<td>@item.SoMe</td>
												<td>@item.ThuTuThung</td>
												<td>@item.GioNhaMay</td>
												<td>@item.PhanLoai</td>
												<td>@item.KL_XeGoong</td>
												<td>@item.KL_Thung</td>
												<td>@item.KL_Thung_GangLong</td>
												<td>@item.KL_GangLong_CanRay</td>
												<td><input type="checkbox" @(item.DenHRC1 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenHRC2 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenDuc1 ? "checked" : "") disabled /></td>
												<td><input type="checkbox" @(item.DenDuc2 ? "checked" : "") disabled /></td>
												<td>@item.GioNM</td>
												<td>@item.GhiChu</td>
												<td><input type="checkbox" class="chon-thung-checkbox"/></td>
												<td>
													@if (item.DaChuyen)
													{
														<button class="btn btn-danger btn-sm">Chưa chuyển</button>
													}
													else
													{
														<button class="btn btn-success btn-sm">Đã chuyển</button>
													}
												</td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col"> </td>
												<td class="toggle-col">
													@if (item.TrangThai == 1)
													{
														<button class="btn btn-danger btn-sm">Chưa chuyển</button>
													}
													else if (item.TrangThai == 2)
													{
														<button class="btn btn-warning btn-sm">Chờ xử lý</button>
													}
													else
													{
														<button class="btn btn-success btn-sm">Đã chốt</button>
													}
												</td>
											</tr>
										}
									}
								</tbody>
							</table>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>
}

<script>
	$(document).ready(function()
	{
		// Chọn/bỏ chọn tất cả
		$('#selectAll').change(function() {
			$('.chon-thung-checkbox').prop('checked', $(this).prop('checked'));
		});

		// Kiểm tra trạng thái checkbox
		$('.chon-thung-checkbox').change(function() {
			const allChecked = $('.chon-thung-checkbox').length === $('.chon-thung-checkbox:checked').length;
			$('#selectAll').prop('checked', allChecked);
		});

		// Nút chuyển thùng
		$('.btn-success').click(function() {
			const selectedIds = [];
			console.log("======",selectedIds)
			$('.chon-thung-checkbox:checked').each(function() {
				const row = $(this).closest('tr');
				const maThung = row.find('td:eq(2)').text();
				const daChuyen = row.find('td:eq(17)').find('button').hasClass('btn-success');

				if (daChuyen) {
					alert(`Thùng ${maThung} đã được chuyển trước đó`);
					return false;
				}

				selectedIds.push(maThung);
			});

			if (selectedIds.length === 0) {
				alert('Vui lòng chọn ít nhất một thùng');
				return;
			}

			if (confirm(`Bạn có chắc chắn muốn chuyển ${selectedIds.length} thùng đã chọn?`)) {
				chuyenThung(selectedIds);
			}
		});

		// Nút thu hồi thùng
		$('.btn-danger').click(function() 
		{
			const selectedMaThungs = [];
			console.log("======",selectedMaThungs)
			$('.chon-thung-checkbox:checked').each(function () {
				const row = $(this).closest('tr');
				const maThung = row.find('td:eq(2)').text(); // Cột chứa mã thùng gang
			selectedMaThungs.push(maThung);
			});

			if (selectedMaThungs.length === 0) 
			{
				alert('Vui lòng chọn ít nhất một thùng để thu hồi');
				return;
			}

			if (confirm(`Bạn có chắc chắn muốn thu hồi ${selectedMaThungs.length} thùng đã chọn?`)) 
			{
				thuHoiThung(selectedMaThungs);
			}
		});

		// Ẩn/hiện cột
		let isHidden = true;
		$('#toggleColumnsBtn').on('click', function() {
			if (isHidden) {
				$('th.toggle-col, td.toggle-col').show();
			} else {
				$('th.toggle-col, td.toggle-col').hide();
			}
			isHidden = !isHidden;
		});
	});

	// Hàm gọi API chuyển thùng
	function chuyenThung(dsthung) 
		{
			$.ajax({
				url: '@Url.Action("ChuyenThung", "BM16_GangThoi")',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(dsthung),
				success: function(response) {
					if (response.success) {
						alert(response.message);
						location.reload();
					} else {
						alert(response.message);
					}
				},
				error: function() {
					alert('Có lỗi xảy ra khi gửi yêu cầu');
				}
			});
		}
	function thuHoiThung(dsMaThung) 
		{
			$.ajax({
				url: '@Url.Action("ThuHoiThung", "BM16_GangThoi")',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify(dsMaThung),
				success: function (response) {
					   showAlert(response.message, response.success ? 'success' : 'danger');
						if (response.success) {
						  setTimeout(() => {
							location.reload();
						  }, 2000); // Đợi 2s cho người dùng đọc alert
						}
					  },
					  error: function () {
						showAlert('Có lỗi xảy ra khi gửi yêu cầu thu hồi thùng', 'danger');
					  }
					});
		}
			function showAlert(message, type) {
			  const alertHtml = `
				<div class="alert alert-${type} alert-dismissible fade show" role="alert">
				  ${message}
				  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Đóng"></button>
				</div>
			  `;
			  const alertContainer = document.getElementById('alertContainer');
			  alertContainer.innerHTML = alertHtml;

			  // Tự động ẩn sau 5 giây
			  setTimeout(() => {
				const alert = alertContainer.querySelector('.alert');
				if (alert) {
				  alert.classList.remove('show');
				  alert.classList.add('hide');
				}
			  }, 5000);
			}


</script>