@using Data_Product.Models
@using System.Security.Claims;
@using Data_Product.Repositorys;
@using Microsoft.EntityFrameworkCore;
@inject Data_Product.Repositorys.DataContext _context
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script src="~/Content/assets/Chonse/chosen.jquery.js"></script>
<link href="~/Content/assets/Chonse/chosen.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
	table th {
		text-align: center;
	}

	#dataTable input {
		border-radius: 0px !important;
	}

</style>
@if (TempData["msgSuccess"] != null)
{
	@Html.Raw(TempData["msgSuccess"])
}
@if (TempData["msgError"] != null)
{
	@Html.Raw(TempData["msgError"])
}
@{
	ViewData["Title"] = "Index";
	Layout = "~/Views/Shared/_Layout.cshtml";

	Pager pager = new Pager();
	int pageNo = 0;
	if (ViewBag.Pager != null)
	{
		pager = ViewBag.Pager;
		pageNo = pager.CurrentPage;
	}
}
@{
	var TenTaiKhoan = User.FindFirstValue(ClaimTypes.Name);
	var TaiKhoan = _context.Tbl_TaiKhoan.Where(x => x.TenTaiKhoan == TenTaiKhoan).FirstOrDefault();

}
@using (Html.BeginForm("TaoPhieu", "BM16_GangThoi", FormMethod.Post, new { enctype = "multipart/form-data", id = "TaoPhieu" }))
{
	<div class="app-main__outer">
		<div class="app-main__inner" style="display:block;padding-bottom: 0px;">
			<div class="tab-content">
				<div class="row">
					<div class="card">

						<!-- Row 1: Tiêu đề + nút thao tác -->
						<div class="row w-100">
							<div style="display: flex; border-bottom: 0.8px solid #E8E8E8; position: absolute; background-color: #F9F9F9; width: 100%; height: 80px;">

								<!-- Tiêu đề -->
								<div style="flex: 1; text-align: left; padding: 2% 2% 2% 0%;">
									<span class="text-muted small pt-2 ps-1">
										<b style="color:#06428b; font-size: 15px;">
											TẠO PHIẾU GIAO NHẬN GANG LỎNG - GANG THỎI
										</b>
									</span>
								</div>

								<!-- Nút thao tác -->
								<div style="display: flex; gap: 10px; align-items: center; padding: 2% 2% 2% 0%; margin-left: auto;">
									<button type="button" class="btn btn-secondary" onclick="location.reload();">
										<i class="bi bi-arrow-clockwise"></i>
										<span class="small pt-2 ps-1 text-white">Làm mới</span>
									</button>
									<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmCancelModal">
										<i class="bi bi-x-lg"></i>
										<span class="small pt-2 ps-1 text-white">Hủy bỏ</span>
									</button>
									<button type="submit" class="btn btn-success" name="btnSave" id="btnSave" value="1">
										<i class="bi bi-send"></i>
										<span class="small pt-2 ps-1 text-white">Lưu phiếu</span>
									</button>
								</div>
							</div>
						</div>

						<!-- Row 2: Bộ lọc tìm kiếm -->
						<div class="row w-100 pt-4" style="padding-top: 5.5rem !important;">
							<div class="col-lg-12">
								<div class="row g-3 align-items-end">

									<!-- Ngày -->
									<div class="col">
										<div class="d-flex align-items-center bg-light rounded shadow-sm px-3 py-2">
											<label for="ID_Day" class="form-label mb-0 text-dark me-2" style="font-size: 14px; min-width: 90px;">Ngày:</label>
											<input type="date" id="ID_Day" name="ID_Day" class="form-control form-control-sm"
												   min="@ViewBag.MinDate" max="@ViewBag.MaxDate"
												   value="@ViewBag.DefaultDate" onkeydown="return false;" />
										</div>
									</div>

									<!-- Lò cao -->
									<div class="col">
										<div class="d-flex align-items-center bg-light rounded shadow-sm px-3 py-2">
											<label for="IDLoCao" class="form-label mb-0 text-dark me-2" style="font-size: 14px; min-width: 90px;">Lò cao:</label>
											<select class="form-select form-select-sm w-auto" name="LoCao" id="IDLoCao">
												<option value="null">-- Lò cao --</option>
												<option value="1">Lò cao 1</option>
												<option value="2">Lò cao 2</option>
												<option value="3">Lò cao 3</option>
												<option value="4">Lò cao 4</option>
											</select>
										</div>
									</div>

									<!-- Ca -->
									<div class="col">
										<div class="d-flex align-items-center bg-light rounded shadow-sm px-3 py-2">
											<label for="IDCa" class="form-label mb-0 text-dark me-2" style="font-size: 14px; min-width: 90px;">Ca:</label>
											<select class="form-select form-select-sm w-auto SelectCA" name="IDCa" id="IDCa">
												<option value="null">-- Ca --</option>
												<option value="1">1</option>
												<option value="2">2</option>
											</select>
										</div>
									</div>

									<!-- Kíp -->
									<div class="col d-flex align-items-center">
										<label for="CaKip" class="col-form-label fw-semibold me-2 mb-0">Kíp:</label>
										<select id="CaKip" class="form-select form-select-sm" disabled>
											<option value="null" selected>-- Kíp làm việc --</option>
										</select>
									</div>
									<!-- Nút tìm -->
									<div class="col d-flex align-items-center justify-content-end">
										<button type="submit" class="btn btn-primary px-4 py-2 fs-6" name="btnSearch" id="btnSearch" value="1">
											<i class="bi bi-search"></i>
											<span class="ps-2">Tìm kiếm</span>
										</button>
									</div>

								</div>

							</div>
						</div>
					</div>


					<div class="card-body" style="padding-top: 0%; overflow-x: auto; font-size: 12px;">
						<button id="toggleColumnsBtn" type="button" class="btn btn-outline-secondary btn-sm mb-2">
							Ẩn/Hiện
						</button>
						<button type="button" class="btn btn-success me-2">
							<i class="bi bi-arrow-right-circle"></i> Chuyển
						</button>

						<button type="button" class="btn btn-danger">
							<i class="bi bi-arrow-counterclockwise"></i> Thu hồi
						</button>
						<div class="table-responsive" style="height: auto;">
							<table class="table table-bordered table-hover align-middle text-center" id="dataTable">
								<thead class="table-light">
									<tr>
										<th rowspan="2">Xóa</th>
										<th rowspan="2">Copy thùng</th>
										<th rowspan="2">Mã thùng</th>
										<th rowspan="2">Số mẻ</th>
										<th rowspan="2">Thùng số</th>
										<th rowspan="2">Giờ</th>
										<th rowspan="2">Phân loại</th>
										<th rowspan="2">KL xe goong</th>
										<th rowspan="2">KL thùng</th>
										<th rowspan="2">KL thùng &amp; gang lỏng</th>
										<th rowspan="2">KL gang lỏng cân ray</th>
										<th colspan="4">Vận chuyển đến</th>
										<th rowspan="2">Giờ NM</th>
										<th rowspan="2">Ghi chú</th>
										<th rowspan="2" class="toggle-col">Người nhận 1</th>
										<th rowspan="2" class="toggle-col">BP nhận 1</th>
										<th rowspan="2" class="toggle-col">Người nhận 2</th>
										<th rowspan="2" class="toggle-col">BP nhận 2</th>
									</tr>
									<tr>
										<th>NM.HRC1</th>
										<th>NM.HRC2</th>
										<th>Đúc1</th>
										<th>Đúc2</th>
									</tr>
								</thead>
								<tbody>
									<tr id="addRowBtnContainer">
									</tr>
								</tbody>
							</table>
						</div>
					</div>

				</div>
			</div>
		</div>
	</div>
}

@* -- Begin modal cảnh báo hủy phiếu-- *@
<div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title" id="confirmCancelModalLabel">Xác nhận hủy bỏ</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Đóng"></button>
			</div>
			<div class="modal-body">
				Bạn có chắc chắn muốn hủy bỏ thao tác và quay lại trang chính không?
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Không</button>
				<a href="@Url.Action("Index", "Menu")" class="btn btn-danger">Có, hủy bỏ</a>
			</div>
		</div>
	</div>
</div>
@* -- End modal cảnh báo hủy phiếu-- *@
@section Scripts {
	<script>
		$(document).ready(function () {
				let maxIndex = 0;
				$("#btnSearch").on("click", function (e) {
				e.preventDefault(); // Ngăn submit form nếu có

				let selectedDate = $("#ID_Day").val();
					console.log(selectedDate);
				let selectedLoCao = $("#IDLoCao").val();
					console.log("locao",selectedLoCao);
				let selectedCa = $("#IDCa").val();
					console.log("calamviec",selectedCa);
				let selectedKip = $("#CaKip").val();
					console.log("cakip",selectedKip);

				// Kiểm tra dữ liệu đầu vào
				if (!selectedDate || selectedLoCao === "null" || !selectedKip || selectedKip === "null") {
					alert("Vui lòng chọn đầy đủ Ngày, Lò cao, Ca, Kíp!");
					return;
				}
				// Gọi hàm lấy dữ liệu từ server
				loadTableData(selectedDate, selectedLoCao, selectedKip,selectedCa);
			});

					function loadTableData(selectedDate, selectedLoCao, selectedKip,selectedCa) {
					$.ajax({
						url: "/BM16_GangThoi/GetSoMeGangBKMis",
						type: "GET",
						data: {
							ngay: selectedDate,
							ID_LoCao: selectedLoCao,
							IDKip: selectedKip
						},
						success: function (data) {
							console.log(data);
							maxIndex = data.length;
							let tableBody = $("#dataTable tbody");
							tableBody.find("tr:not(#addRowBtnContainer)").remove();

							$.each(data, function (index, item) {
								let soMe = item.testPatternCode ? item.testPatternCode : "";
								let thungSo = soMe.length >= 2 ? soMe.slice(-2) : "";
								let phanLoai = item.classifyName ? item.classifyName : "";
								let time = item.patterntime ? item.patterntime.replace(/H/g, ":") : "";
								let maThung= generateMaThung(selectedDate, selectedLoCao, selectedCa, index + 1);
								let row = `
									<tr>
											<td class='text-center delItem' >

											<a class="btn btn-danger btn-sm" title="Xóa">
												<i class="bi bi-trash"></i>
											</a>
										</td>
											<td class='text-center copyItem'>
											<a class="btn btn-secondary btn-sm copyRowBtn" title="Copy dòng">
												<i class="bi bi-copy"></i>
											</a>
										</td>
											<td name="maThung">${maThung}</td>
											<td name="soMe">${soMe}</td>
											<td name="ThungSo">${thungSo}</td>
											<td name="Gio">${time}</td>
											<td name="PhanLoai">${phanLoai}</td>
											<td><input type="number" name="KhoiLuongXeGoong" class="form-control" style="width: 100px; padding: 4px;"></td>
											<td><input id="KLThung_${index}" name="KhoiLuongThung" type="number" step="0.01" min="0.01" class="form-control" value="" style="width: 100px; padding: 4px;"></td>
											<td><input id="KLThungGL_${index}" name="KLThungGangLong" type="number" step="0.01" min="0.01" class="form-control" value="" style="width: 100px; padding: 4px;"></td>
											<td><input id="KLGLCR_${index}" name="KLGangLong" type="number" step="0.01" min="0.01" class="form-control" value="" style="width: 100px; padding: 4px;"></td>
											<td><input type="checkbox" name="VanChuyenHRC1" class="form-check-input" style="width: 20px; height: 20px;"></td>
											<td><input type="checkbox" name="VanChuyenHRC2" class="form-check-input" style="width: 20px; height: 20px;"></td>
											<td><input type="checkbox" name="VanChuyenDUC1" class="form-check-input" style="width: 20px; height: 20px;"></td>
											<td><input type="checkbox" name="VanChuyenDUC2" class="form-check-input" style="width: 20px; height: 20px;"></td>
											<td>${time}</td>
											<td><textarea name="GhiChu" class="form-control" rows="2" style="width: 180px; resize: none; padding: 4px;"></textarea></td>
											<td class="toggle-col"> </td>
											<td class="toggle-col"> </td>
											<td class="toggle-col"> </td>
											<td class="toggle-col"> </td>

									</tr>
								`;

									$(row).insertBefore("#addRowBtnContainer");
							});
						},
						error: function (err) {
							console.error("Lỗi tải dữ liệu: ", err);
						}
					});
				}

				$("#IDCa").change(function () {
					let selectedCa = $(this).val();
					let selectedDate = $("#ID_Day").val();
					let kipDropdown = $("#CaKip");

					// Reset dropdown
					kipDropdown.empty().append("<option value='null'>-- Kíp làm việc --</option>").prop("disabled", true);

					if (!selectedCa || selectedCa === "null" || !selectedDate) return;

					$.ajax({
						url: "/BM16_GangThoi/GetKipFromCa",
						type: "GET",
						data: { Ngay: selectedDate, Ca: selectedCa },
						success: function (res) {
							kipDropdown.empty().prop("disabled", true);
							if (res.length > 0) {
								$.each(res, function (index, item) {
									kipDropdown.append(`<option value='${item.iD_Kip}' data-info='${item.tenKip}'>${item.tenKip}</option>`);
								});
							} else {
								kipDropdown.append("<option value='null' disabled selected>-- Kíp làm việc --</option>");
							}
						},
						error: function (err) {
							console.error("Lỗi khi tải dữ liệu kíp: ", err);
							kipDropdown.empty().append("<option value='null' disabled selected>-- Kíp làm việc --</option>").prop("disabled", true);
						}
					});
				});

				$(document).on("click", ".delItem a", function (e) {
					e.preventDefault();
					$(this).closest("tr").remove();
				});
	@* begin hàm copy dòng  *@

					$(document).on("click", ".copyRowBtn", function () {
					const row = $(this).closest("tr");
					const clonedRow = row.clone(true);
					const maThungCell = row.find("td[name='maThung']");
					let maThung = maThungCell.text().trim(); // Ví dụ: 280525L2N001.00

					let [prefix, _] = maThung.split(".");

	@* // Tìm hậu tố lớn nhất có cùng tiền tố *@
					let maxSuffix = 0;
					$("td[name='maThung']").each(function () {
						let text = $(this).text().trim();
						let [pfx, sfx] = text.split(".");
						if (pfx === prefix) {
							let number = parseInt(sfx, 10);
							if (!isNaN(number)) {
								maxSuffix = Math.max(maxSuffix, number);
							}
						}
					});

	@* // Sinh mã mới *@
					let newMaThung = `${prefix}.${(maxSuffix + 1).toString().padStart(2, '0')}`;
					clonedRow.find("td[name='maThung']").text(newMaThung);

	@* // Tìm vị trí chèn đúng thứ tự tăng dần theo Mã Thùng *@
					let inserted = false;
					$("#dataTable tbody tr").each(function () {
						const currentCell = $(this).find("td[name='maThung']");
						if (currentCell.length > 0) {
							let currentMaThung = currentCell.text().trim();
							if (currentMaThung > newMaThung) {
								clonedRow.insertBefore($(this));
								inserted = true;
								return false;
							}
						}
					});

	@* 	// Nếu không có dòng nào lớn hơn thì chèn trước nút "Thêm dòng" *@
					if (!inserted) {
						$("#addRowBtnContainer").before(clonedRow);
					}
				});

	@* end hàm copy dòng *@

		$(document).ready(function () {
		// Tìm các cột toggle-col theo vị trí (index bắt đầu từ 1)
		let toggleColIndexes = [15,16,17,18];

		// Duyệt qua hàng tiêu đề để lấy vị trí các cột có class toggle-col
		$('#dataTable thead tr:first-child th').each(function (index) {
			if ($(this).hasClass('toggle-col')) {
				toggleColIndexes.push(index + 1); // nth-child dùng 1-based index
			}
		});

		// Hàm ẩn các cột
		function hideToggleColumns() {
			toggleColIndexes.forEach(i => {
				$('#dataTable th:nth-child(' + i + ')').hide();  // Ẩn tiêu đề
				$('#dataTable td:nth-child(' + i + ')').hide();  // Ẩn ô dữ liệu
			});
		}

		// Hàm hiện các cột
		function showToggleColumns() {
			toggleColIndexes.forEach(i => {
				$('#dataTable th:nth-child(' + i + ')').show();  // Hiện tiêu đề
				$('#dataTable td:nth-child(' + i + ')').show();  // Hiện ô dữ liệu
			});
		}
		// Ẩn ngay khi load
		hideToggleColumns();
		// Bật tắt khi bấm nút
		let isHidden = true;
		$('#toggleColumnsBtn').on('click', function () {
			if (isHidden) {
				showToggleColumns();
			} else {
				hideToggleColumns();
			}
			isHidden = !isHidden;
			});
		});
		$(document).on("change", ".form-check-input", function () {
			let row = $(this).closest("tr");
			row.find(".form-check-input").not(this).prop("checked", false);
		});

		$(document).on("input", "input[id^='KLThung_'], input[id^='KLThungGL_']", function () {
			let index = $(this).attr("id").split("_")[1];
			let klThung = parseFloat($("#KLThung_" + index).val()) || 0;
			let klThungGL = parseFloat($("#KLThungGL_" + index).val()) || 0;

			let klGLCR = (klThungGL - klThung) ? parseFloat((klThungGL - klThung).toFixed(2)) : 0;

			$("#KLGLCR_" + index).val(klGLCR);
		});

		});
				// Hàm tạo mã thùng
		function generateMaThung(dateStr, loCao, ca, stt) {
			const date = new Date(dateStr);
			const dd = String(date.getDate()).padStart(2, '0');
			const mm = String(date.getMonth() + 1).padStart(2, '0');
			const yy = String(date.getFullYear()).slice(-2);

			const caChar = (ca === '1') ? 'N' : 'D';
			const sttFormatted = String(stt).padStart(3, '0');

			return `${dd}${mm}${yy}L${loCao}${caChar}${sttFormatted}.00`;
		}
		$(document).ready(function () {
		  $("#btnSave").on("click", function (e) {
			e.preventDefault();

			let phieuData = {
			  Ngay: $("#ID_Day").val(),
			  LoCao: $("#IDLoCao").val(),
			  Ca: $("#IDCa").val(),
			  Kip: $("#CaKip").val(),
			  DanhSachThung: []
			};

			$("#dataTable tbody tr").not("#addRowBtnContainer").each(function () {
			  let $tr = $(this);

			  let thung = {
				MaThung: $tr.find("td[name='maThung']").text().trim(),
				SoMe: $tr.find("td[name='soMe']").text().trim(),
				ThungSo: $tr.find("td[name='ThungSo']").text().trim(),
				Gio: $tr.find("td[name='Gio']").text().trim(),
				PhanLoai: $tr.find("td[name='PhanLoai']").text().trim(),
				KhoiLuongXeGoong: $tr.find("input[name='KhoiLuongXeGoong']").val(),
				KhoiLuongThung: $tr.find("input[name='KhoiLuongThung']").val(),
				KLThungGangLong: $tr.find("input[name='KLThungGangLong']").val(),
				KLGangLong: $tr.find("input[name='KLGangLong']").val(),
				VanChuyenHRC1: $tr.find("input[name='VanChuyenHRC1']").is(":checked"),
				VanChuyenHRC2: $tr.find("input[name='VanChuyenHRC2']").is(":checked"),
				VanChuyenDUC1: $tr.find("input[name='VanChuyenDUC1']").is(":checked"),
				VanChuyenDUC2: $tr.find("input[name='VanChuyenDUC2']").is(":checked"),
				GioNM: $tr.find("td").eq(15).text().trim(),
				GhiChu: $tr.find("textarea[name='GhiChu']").val()
			  };

			  phieuData.DanhSachThung.push(thung);
			});

			if (!phieuData.Ngay || phieuData.LoCao === "null" || phieuData.Ca === "null" || phieuData.Kip === "null") {
			  alert("Vui lòng điền đầy đủ thông tin phiếu!");
			  return;
			}

			const dataToSend = {
			  ID_LoCao: parseInt(phieuData.LoCao),
			  ID_Kip: parseInt(phieuData.Kip),
			  ID_Ca:parseInt(phieuData.Ca),
			  ThungGangs: phieuData.DanhSachThung.map(x => ({
				MaThungGang: x.MaThung,
				BKMIS_SoMe: x.SoMe,
				BKMIS_ThungSo: x.ThungSo,
				BKMIS_Gio: x.Gio,
				BKMIS_PhanLoai: x.PhanLoai,
				KL_XeGoong: parseFloat(x.KhoiLuongXeGoong) || 0,
				G_KLThungChua: parseFloat(x.KhoiLuongThung) || 0,
				G_KLThungVaGang: parseFloat(x.KLThungGangLong) || 0,
				G_KLGangLong: (parseFloat(x.KLThungGangLong) || 0) - (parseFloat(x.KhoiLuongThung) || 0),
			    ChuyenDen:x.VanChuyenHRC1 ? "HRC1" : x.VanChuyenHRC2 ? "HRC2" : x.VanChuyenDUC1 ? "DUC1" : x.VanChuyenDUC2 ? "DUC2" : "KHONG_XAC_DINH",
				G_GhiChu: x.GhiChu
			  }))
			};

			$.ajax({
			  url: '/BM16_GangThoi/TaoPhieu',
			  type: 'POST',
			  contentType: 'application/json',
			  data: JSON.stringify(dataToSend),
			  headers: {
				'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
			  },
			  success: function(response) {
				console.log('Success', response);
				alert('Tạo phiếu thành công!');
			  },
			  error: function(xhr, status, error) {
				console.error('Error', xhr.responseText);
				alert('Lỗi khi tạo phiếu!');
			  }
			});
		  });
		});
	</script>
	<script type="text/javascript">
		$("#IDTaiKhoan, #IDTaiKhoan_QLCL").chosen({
			width: "100%"
		});

		$("#IDKip").chosen({
			width: "100%"
		});
		$(document).ready(function () {
			$('#multiSelect').chosen({
				width: '100%'
			});
		});
	</script>
}